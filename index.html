<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        /* ... SEU C√ìDIGO CSS (STYLE) ORIGINAL PERMANECE AQUI INTACTO ... */
        :root{
            /* CORES PRINCIPAIS: AZUL MARINHO ESCURO PRIM√ÅRIO, VERMELHO SECUND√ÅRIO */
            --primary: #0A0A33;  /* Azul Marinho Escuro */
            --primary-light: #1A1A55; /* Vers√£o mais clara para gradiente/hover */
            --secondary: #C00000; /* Vermelho Forte (Secund√°rio/Destaque) */
            --secondary-light: #E00000; /* Vermelho Claro para gradiente/hover */
            --danger: #c62828;  /* Mantido para a√ß√µes de exclus√£o */
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        /* Base */
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        /* Ajuste do Logo e T√≠tulo para ficarem √† esquerda e alinhados */
        #siteLogo{
            display:block; /* Muda para block */
            max-width:140px;
            width:100%;
            height:auto;
            border-radius:6px;
            box-shadow:var(--shadow);
            margin:0 0 6px 0; /* Remove margem autom√°tica, alinha √† esquerda */
        }
        #logo-wrapper{ /* Este se torna desnecess√°rio, mas o mantive no HTML abaixo para o logo */
            margin-bottom:8px;
        }
        /* Header */
        #header-container{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:8px;
            /* Para manter o cont√™iner √† esquerda se o logo estiver no topo */
            width: fit-content;
        }
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); }
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        /* Cont√™iner para logo e t√≠tulo juntos */
        #left-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Top actions compacto */
        #top-actions{
            display:flex; align-items:center; gap:10px; padding:10px;
            background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border);
            flex-wrap:wrap;
        }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        /* --------------- BOT√ïES S√ìLIDOS COM CONTORNO BRANCO (ESTILO TRAVELEX) --------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            /* Estilo Padr√£o (AZUL MARINHO): Fundo Primary, Texto Branco, Borda Branca */
            background: var(--primary); /* Fundo Azul Marinho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Sombra padr√£o */
        }
        /* Estilo Secund√°rio (VERMELHO): Fundo Secondary, Texto Branco, Borda Branca */
        .btn.secondary {
            background: var(--secondary); /* Fundo Vermelho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
        }
        .btn.small {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 7px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            background: var(--primary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
        }
        .btn.secondary:hover {
            background: var(--secondary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
            box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25);
        }
        .btn:active {
            transform: none;
            filter: brightness(0.96);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        /* O bot√£o danger √© usado no delete, mas como voc√™ quer ele VERMELHO (secondary),
            ele usar√° o estilo .btn.secondary, com uma pequena varia√ß√£o de cor */
        .btn.danger {
            background: var(--secondary);
            color: white;
            border: 1px solid white;
            box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25);
        }
        .btn.danger:hover {
            filter: brightness(0.85);
            border-color: white;
        }
        /* ----------------------------------------------------------- */
        /* Layout empilhado: resultados em cima, painel embaixo */
        #main-container{
            display:flex;
            flex-direction:column;
            gap:14px;
            align-items:stretch;
        }
        /* Cards */
        .card{
            background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border);
            color:var(--text-dark);
        }
        /* Inputs */
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"]{
            padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px;
        }
        /* Totals */
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        /* Ganho total em verde */
        #totalCdiDisplay p { color: var(--success) !important; }
        /* Tabela */
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{
            position:sticky; top:0; z-index:2;
            /* Tira grande agora √© Azul Marinho */
            background: linear-gradient(180deg,var(--primary-light),var(--primary));
            color:white; padding:10px 8px; text-align:left; font-weight:700;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        /* Descri√ß√£o/Resumo usa o novo primary (Azul Marinho) */
        .col-left{
            text-align:left;
            max-width:260px;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            color: var(--primary);
            font-weight: 600;
        }
        /* A√ß√µes compactas */
        .action-cell{ text-align:center; }
        /* --------------- GANHO/PERDA (BADGE) E NEGRITO GERAL --------------- */
        /* Estilo de Badge aplicado ao conte√∫do da TD */
        .ganho, .perda {
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        .ganho {
            color: var(--success) !important;
            background: rgba(46, 125, 50, 0.1);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }
        .perda {
            color: var(--danger) !important;
            background: rgba(198, 40, 40, 0.1);
            border: 1px solid rgba(198, 40, 40, 0.2);
        }
        /* Estilo para b/strong em geral */
        b, strong {
            font-weight: 800;
            color: var(--primary); /* Negrito no Azul Marinho do tema */
        }
        /* ------------------------------------------------------------------- */
        /* Responsive */
        @media (max-width:980px){
            /* Centraliza em telas pequenas */
            #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; }
            #header-container{ margin-bottom:0; width: 100%; justify-content: center; }
            #left-header-content { justify-content: center; }
            .input-row{ flex-direction:column; align-items:stretch; }
        }
        /* Print */
        @media print{
            body{ background:white; padding:0; color:black; }
            #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn { display:none; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="xlsx.mini.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body onload="loadState()">
    <div id="logo-wrapper">
        <img id="siteLogo" alt="Logo do site">
    </div>
    <div id="header-container">
        <div id="left-header-content">
            <div id="logo-placeholder">üìà</div>
            <h1>Controle de Ganhos CDI</h1>
        </div>
    </div>
        <div id="auth-status" class="card" style="padding: 10px; margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between;">
        <span id="login-message" style="font-weight: 600;">Status: Desconectado</span>
        <button id="loginBtn" class="btn small">Login (An√¥nimo)</button>
    </div>
        <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
        <div id="header-left">
            <div style="font-weight:700;">Resumo Di√°rio</div>
            <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
        </div>
                <div id="header-right">
            <button id="printBtn" class="btn small" title="Imprimir">Imprimir</button>
            
            <button id="saveBtn" class="btn small secondary" title="Salvar em Nuvem">üíæ Salvar</button>
            
            <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>
                        <label class="file-label" for="excelFile" title="Selecionar arquivos">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple>
                <span class="btn small">Procurar</span>
            </label>
            <button id="loadExcelBtn" class="btn small secondary" title="Importar arquivos">Importar</button>
            <label class="logo-label" for="logoFile" title="Carregar logo">
                <input type="file" id="logoFile" accept="image/*">
                <span class="btn small">Procurar</span>
            </label>
            <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo">Carregar Logo</button>
            <button id="removeLogoBtn" class="btn small" title="Remover">Remover</button>
            <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo">üóëÔ∏è</button>
        </div>
    </div>
    <div id="main-container">
        <div id="results-panel" class="card">
            <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>
            <div class="card filter-card" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <div style="font-weight:600;color:var(--muted);">Filtros</div>
                    <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                </div>
                <div class="input-row" style="margin-top:8px;">
                    <div>
                        <label for="filterStartDate">Data de In√≠cio</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div>
                        <label for="filterEndDate">Data de Fim</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;">
                        <button id="filterBtn" class="btn small">Filtrar</button>
                        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-weight:600;color:var(--muted)">
                        <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                    </label>
                </div>
            </div>
            <div class="totals">
                <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
            </div>
            <div class="table-wrap">
                <div id="resultTable"></div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
            </p>
        </div>
        <div id="input-panel" class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>
            </div>
            <div class="input-row">
                <div>
                    <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                    <input type="text" id="taxaCdiAnual" placeholder="14,90" value="14,90" onchange="calculateAndRender()">
                </div>
                <div>
                    <label for="diasAno">Dias no Ano</label>
                    <input type="text" id="diasAno" placeholder="252" value="252" onchange="calculateAndRender()">
                </div>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">üìÇ Importa√ß√£o</h3>
                <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                    *O sistema tenta reconhecer os cabe√ßalhos, priorizando 'TX. 252' para a taxa CDI.
                </p>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">‚ûï Lan√ßamento Manual</h3>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <input type="hidden" id="editIndex" value="-1">
                    <div><label for="manualData">Data do Lan√ßamento</label><br><input type="date" id="manualData" required></div>
                    <div><label for="manualDesc">Descri√ß√£o</label><br><input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s"></div>
                    <div><label for="manualBanco">Banco / Contraparte</label><br><input type="text" id="manualBanco" placeholder="Ex: BTG Pactual"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCedente">Conta Cedente</label><br><input type="text" id="manualCedente" placeholder="8300005"></div>
                        <div style="flex:1;"><label for="manualCessionario">Conta Cession√°rio</label><br><input type="text" id="manualCessionario" placeholder="12000005"></div>
                    </div>
                    <div><label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label><br><input type="text" id="manualCdiTaxa" placeholder="14,90 (Deixar vazio para usar Global)"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCompromissada">Valor Compromissada</label><br><input type="text" id="manualCompromissada" placeholder="10.000,00"></div>
                        <div style="flex:1;"><label for="manualRetorno">Valor Retorno (Bruto)</label><br><input type="text" id="manualRetorno" placeholder="10.050,25"></div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
                        <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
                    </div>
                </div>
            </div>
            <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
        </div>
    </div>
        
<script>
    // ====================================================================
    // FIREBASE REALTIME DATABASE E AUTENTICA√á√ÉO
    // ====================================================================
    
    // Suas chaves de configura√ß√£o do Firebase (MANTIDAS AQUI)
    const firebaseConfig = {
        apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
        authDomain: "controle-cdi.firebaseapp.com",
        databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
        projectId: "controle-cdi",
        storageBucket: "controle-cdi.firebasestorage.app",
        messagingSenderId: "215359645646",
        appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
        measurementId: "G-TV1M1QWQRC"
    };
    let database = null;
    let currentUserUid = null; 
    const DB_ROOT_PATH = 'usuarios/'; 

    // Inicializa o Firebase
    if (typeof firebase !== 'undefined' && typeof firebase.database !== 'undefined' && typeof firebase.auth !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
    } else {
        console.error("Firebase SDKs n√£o carregados. O salvamento/autentica√ß√£o em nuvem n√£o funcionar√£o.");
    }

    // --- L√≥gica de Autentica√ß√£o ---
    const loginBtn = document.getElementById('loginBtn');
    const loginMessage = document.getElementById('login-message');

    function handleLogin() {
        if (!firebase.auth()) {
            loginMessage.textContent = "Erro: Firebase Auth n√£o carregado.";
            return;
        }
        if (currentUserUid) {
            // Se j√° estiver logado, faz logout
            firebase.auth().signOut().then(() => {
                log('Desconectado do Firebase.');
                currentUserUid = null;
                loginBtn.textContent = 'Login (An√¥nimo)';
                loginMessage.textContent = 'Status: Desconectado';
                operacoes = []; // Limpa os dados vis√≠veis
                calculateAndRender();
            });
        } else {
            // Login An√¥nimo: R√°pido e f√°cil para um projeto de usu√°rio √∫nico
            loginMessage.textContent = 'Tentando conectar...';
            firebase.auth().signInAnonymously()
                .then(() => {
                    log('Login an√¥nimo realizado com sucesso.');
                })
                .catch((error) => {
                    log(`‚ùå Erro de Login: ${error.message}`);
                    loginMessage.textContent = 'Status: Falha no Login';
                });
        }
    }

    // Listener para o estado da autentica√ß√£o
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            currentUserUid = user.uid;
            loginMessage.textContent = `Status: Conectado (UID: ${user.uid.substring(0, 8)}...)`;
            loginBtn.textContent = 'Logout';
            log('Conex√£o estabelecida e segura. Carregando seus dados...');
            loadStateFromFirebase(); 
        } else {
            currentUserUid = null;
            loginBtn.textContent = 'Login (An√¥nimo)';
            loginMessage.textContent = 'Status: Desconectado. Fa√ßa login para acessar seus dados.';
            operacoes = [];
            calculateAndRender();
        }
    });

    if (loginBtn) {
        loginBtn.addEventListener('click', handleLogin);
    }
    
    // Conecta o bot√£o Salvar manual ao saveState
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveState);
    }

    // ====================================================================
    /* ---------- Fun√ß√µes utilit√°rias e l√≥gica ---------- */
    function log(message) { document.getElementById('log').textContent = message; }
    
    // ... (Suas outras fun√ß√µes: resetThemeToFixed, compressImageFile, logoInput listener, removeLogoBtn listener) ...
    // Para simplificar a resposta, assumo que estas est√£o corretas.
    
    // Fun√ß√µes de Limpeza e Formata√ß√£o (Seus trechos OK)
    function cleanCurrency(v){ 
         if(typeof v!=='string') v=String(v); 
         let cleanString = v.replace(/[R$\s]/g, '');
        cleanString = cleanString.replace(/\./g, '');
        cleanString = cleanString.replace(/,/g, '.');
        const n=parseFloat(cleanString); 
         return isNaN(n)?0:n; 
     }
    function parseNumber(v){ 
         if(v===undefined||v===null||v==='') return 0; 
         if(typeof v==='string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v); 
         const n=parseFloat(v); 
         return isNaN(n)?0:n; 
     }
    function cleanCdiTaxa(v){ 
         if(v===undefined||v===null||v==='') return 0; 
         if(typeof v!=='string') v=String(v); 
         v=v.replace(/[^0-9,.]/g,''); 
         v = v.replace(/,/g,'.'); // Troca v√≠rgula por ponto universalmente
        // Remove pontos extras, deixando apenas o √∫ltimo (ou nenhum)
        const parts = v.split('.');
        if(parts.length > 2) {
            v = parts.slice(0, -1).join('') + '.' + parts.slice(-1);
        }
        const n=parseFloat(v); 
         return isNaN(n)?0:n; 
     }
    function formatBRL(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); }
    function formatPercent(n){ if(n===undefined||n===null||isNaN(n)) return ''; return n.toFixed(4).replace('.',','); }
    function formatPU(n){ if(n===undefined||n===null||isNaN(n)||n===0) return '-'; return n.toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }
    function formatDataBR(s){ if(!s) return '-'; if(s.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; } if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s; const d=new Date(s); if(!isNaN(d)) return d.toLocaleDateString('pt-BR'); return s; }
    function normalizeDate(s){ 
         if(!s) return ''; 
         s=String(s).trim(); 
         if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
         if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
             const [d,m,y]=s.split('/');
             return `${y}-${m}-${d}`; 
         } 
         const num=parseFloat(s); 
         if(!isNaN(num) && num>25569 && num<70000){ // Excel serial date
            const base=new Date('1899-12-30'); 
             const date=new Date(base.getTime() + num*24*60*60*1000); 
             if(!isNaN(date)){ 
                 const y=date.getUTCFullYear(); 
                 const m=date.getUTCMonth()+1; 
                 const d=date.getUTCDate(); 
                 const pad=n=>n<10?'0'+n:n; 
                 return `${y}-${pad(m)}-${pad(d)}`; 
             } 
         } 
         try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){} 
         return ''; 
     }

    /* Persist√™ncia e estado */
    let operacoes = [], totalCompromissada=0, totalRetorno=0, totalGanho=0;
    let filtroAtivo = false;
    let dataFiltroInicio = null;
    let dataFiltroFim = null;
    
    // FUN√á√ïES DO FIREBASE (CORRIGIDAS/COMPLETAS)
    function saveState(){
         if (!database || !currentUserUid) {
            log("‚ùå √â necess√°rio fazer login para salvar os dados.");
            return;
        }
        const stateToSave = {
            operacoes: operacoes,
            taxaCdiAnual: document.getElementById('taxaCdiAnual').value,
            diasAno: document.getElementById('diasAno').value
        };
        // SALVA DADOS NO CAMINHO SEGURO: usuarios/UID_DO_USUARIO/operacoes
        database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).set(stateToSave)
            .then(() => {
                log(`‚úÖ ${operacoes.length} opera√ß√µes e configura√ß√µes salvas de forma segura!`);
            })
            .catch((error) => {
                log(`‚ùå Erro ao salvar: ${error.message}.`);
                console.error("Firebase Save Error:", error);
            });
    }

    function loadStateFromFirebase(){
        if (!database || !currentUserUid) { 
             operacoes = []; 
             calculateAndRender(); 
             return;
        }
        database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).once('value')
            .then((snapshot) => {
                const savedState = snapshot.val();
                if (savedState && savedState.operacoes) {
                    operacoes = savedState.operacoes || [];
                    document.getElementById('taxaCdiAnual').value = savedState.taxaCdiAnual || '14,90';
                    document.getElementById('diasAno').value = savedState.diasAno || '252';
                    log(`üíæ ${operacoes.length} opera√ß√µes carregadas com sucesso!`);
                } else {
                    operacoes = [];
                    log('Nenhum dado salvo encontrado para este usu√°rio.');
                }
                calculateAndRender(); 
             })
            .catch(error => {
                operacoes = [];
                log(`‚ùå Erro ao carregar dados: ${error.message}.`);
                console.error("Firebase Load Error:", error);
                calculateAndRender(); 
             });
    }

    function loadState() {
        // Tenta carregar o logo e chama loadStateFromFirebase atrav√©s do onAuthStateChanged
        const savedLogo = localStorage.getItem('cdiLogo');
        if (savedLogo) {
            document.getElementById('siteLogo').src = savedLogo;
            document.getElementById('siteLogo').style.display = 'block';
        } else {
            document.getElementById('siteLogo').style.display = 'none';
        }

        // Tenta carregar as configura√ß√µes padr√£o se n√£o estiver logado
        if (!currentUserUid) {
            // Voc√™ pode adicionar uma carga inicial se n√£o houver login
            calculateAndRender();
        }
    }


    // ====================================================================
    // L√ìGICA DE IMPORTA√á√ÉO DE EXCEL (NOVA FUN√á√ÉO ADICIONADA)
    // ====================================================================

    const excelFileInput = document.getElementById('excelFile');
    const loadExcelBtn = document.getElementById('loadExcelBtn');
    
    // Mapeamento de cabe√ßalhos do seu Excel
    const HEADER_MAP = {
        data: ['DATA', 'DT', 'DATA COMPROMISSADA', 'DATA RECOMPRA'],
        descricao: ['DESCRI√á√ÉO', 'RESUMO', 'OPERACAO'],
        banco: ['BANCO', 'CORRETORA', 'CONTRA PARTE'],
        cedente: ['C√ìD. CLIENTE CEDENTE', 'CEDENTE', 'CONTA CEDENTE'],
        cessionario: ['C√ìD. CLIENTE CESSION√ÅRIO', 'CESSIONARIO', 'CONTA CESSION√ÅRIO'],
        cdiTaxa: ['TAXA CDI', 'TX. 252', 'TAXA'],
        compromissada: ['VALOR COMPROMISSADA', 'VALOR COMPR.', 'V. COMPROMISSADA'],
        retorno: ['VALOR RETORNO BRUTO', 'VALOR RETORNO', 'V. RETORNO'],
    };

    function mapHeader(headerRow) {
        const map = {};
        for (const internalKey in HEADER_MAP) {
            const potentialHeaders = HEADER_MAP[internalKey];
            for (let i = 0; i < headerRow.length; i++) {
                // Tratamento de string e case-insensitive
                const excelHeader = String(headerRow[i]).toUpperCase().trim();
                if (potentialHeaders.includes(excelHeader)) {
                    map[internalKey] = i;
                    break;
                }
            }
        }
        return map;
    }

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            if (typeof XLSX === 'undefined') {
                reject(new Error("Biblioteca XLSX n√£o carregada. Verifique 'xlsx.mini.min.js'."));
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // IMPORTANTE: Tenta ler datas serializadas (√∫til para Excel)
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Converte para JSON, preservando as datas como texto no formato ISO
                    const rawJson = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
                    
                    if (rawJson.length < 1) {
                        reject(new Error("O arquivo Excel est√° vazio."));
                        return;
                    }

                    const headerRow = rawJson[0];
                    const dataRows = rawJson.slice(1);
                    const headerMap = mapHeader(headerRow);
                    
                    const novosDados = dataRows.map(row => {
                        // Se o dado for undefined/null, usa a string vazia para evitar erros
                        return {
                            data: normalizeDate(row[headerMap.data]),
                            descricao: String(row[headerMap.descricao] || ''),
                            banco: String(row[headerMap.banco] || ''),
                            cedente: String(row[headerMap.cedente] || ''),
                            cessionario: String(row[headerMap.cessionario] || ''),
                            cdiTaxa: cleanCdiTaxa(row[headerMap.cdiTaxa]),
                            compromissada: cleanCurrency(row[headerMap.compromissada]),
                            retorno: cleanCurrency(row[headerMap.retorno]),
                            source: 'Importado'
                        };
                    }).filter(op => op.data); // Filtra linhas sem data v√°lida

                    resolve(novosDados);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = (error) => reject(error);
            reader.readAsArrayBuffer(file);
        });
    }

    async function loadExcel() {
        const files = excelFileInput.files;
        if (files.length === 0) {
            log('Selecione pelo menos um arquivo Excel/CSV.');
            return;
        }

        let novosRegistros = [];
        let importCount = 0;

        for (const file of files) {
            log(`Processando arquivo: ${file.name}...`);
            try {
                const data = await readExcelFile(file);
                novosRegistros.push(...data);
                importCount += data.length;
                log(`‚úÖ Arquivo ${file.name} processado. ${data.length} registros encontrados.`);
            } catch (error) {
                log(`‚ùå Erro ao ler ${file.name}: ${error.message}`);
                console.error(error);
            }
        }

        if (novosRegistros.length > 0) {
            // Adiciona os novos registros e mant√©m os antigos
            const combinedOps = [...operacoes, ...novosRegistros];
            
            // Simples filtro de duplicatas
            const uniqueOps = combinedOps.filter((op, index, self) =>
                index === self.findIndex((t) => (
                    t.data === op.data && 
                    t.descricao === op.descricao && 
                    t.compromissada === op.compromissada
                ))
            );

            operacoes = uniqueOps;
            log(`Importa√ß√£o conclu√≠da: ${importCount} novos lan√ßamentos (Total: ${operacoes.length}).`);
            calculateAndRender();
            saveState(); // Salva em nuvem ap√≥s a importa√ß√£o
        } else {
            log('Nenhum registro v√°lido foi importado.');
        }
    }

    if (loadExcelBtn) {
        loadExcelBtn.addEventListener('click', loadExcel);
    }
    
    // ====================================================================
    // L√ìGICA DE C√ÅLCULO, RENDERIZA√á√ÉO E CRUD MANUAL (COMPLETA√á√ÉO DO SEU TRECHO)
    // ====================================================================
    
    function calculateAndRender() {
        const taxaGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual').value) / 100;
        const diasAno = parseNumber(document.getElementById('diasAno').value) || 252;
        const showOps = document.getElementById('showIndividualOps').checked;
        
        let filteredOps = operacoes.slice();
        
        // 1. L√≥gica de Filtro (Se estiver ativa)
        if (filtroAtivo && dataFiltroInicio && dataFiltroFim) {
             const start = new Date(dataFiltroInicio + 'T00:00:00');
             const end = new Date(dataFiltroFim + 'T23:59:59');
             
             filteredOps = operacoes.filter(op => {
                 const opDate = new Date(op.data + 'T00:00:00');
                 return opDate >= start && opDate <= end;
             });
             log(`Filtro ativo: ${filteredOps.length} de ${operacoes.length} opera√ß√µes exibidas.`);
        }
        
        // 2. C√°lculos Globais
        totalCompromissada = 0;
        totalRetorno = 0;
        totalGanho = 0;
        
        const operacoesComCalculo = filteredOps.map(op => {
            const taxa = op.cdiTaxa > 0 ? (op.cdiTaxa / 100) : taxaGlobal;
            
            // C√°lculo do Ganho/Perda
            let ganhoPerda = op.retorno - op.compromissada;
            
            // L√≥gica de Invers√£o para RECOMPRA
            if (op.descricao && String(op.descricao).toUpperCase().includes('RECOMPRA')) {
                // Na recompra, o valor que saiu da sua conta √© o retorno, e o valor que voltou √© a compromissada (ou vice-versa)
                // O Ganho/Perda √© o valor final - valor inicial. 
                // Se Retorno √© o que 'entrou' e Compromissada √© o que 'saiu', na RECOMPRA voc√™ quer que o ganho seja positivo se Retorno > Compromissada.
                // Mas, se for uma recompra do seu lado (venda do ativo), voc√™ quer o valor de venda (Retorno) menos o valor de custo (Compromissada).
                // Vamos manter o c√°lculo simples: Retorno - Compromissada. Se for negativo, √© perda.
                ganhoPerda = op.retorno - op.compromissada; 
            }

            totalCompromissada += op.compromissada;
            totalRetorno += op.retorno;
            totalGanho += ganhoPerda;

            return {
                ...op,
                taxaAplicada: taxa * 100, // em porcentagem
                ganho: ganhoPerda
            };
        });
        
        // 3. Renderiza√ß√£o dos Totais
        document.getElementById('totalCompromissadaDisplay').querySelector('p').textContent = formatBRL(totalCompromissada);
        document.getElementById('totalRetornoDisplay').querySelector('p').textContent = formatBRL(totalRetorno);
        document.getElementById('totalCdiDisplay').querySelector('p').textContent = formatBRL(totalGanho);
        
        // 4. Renderiza√ß√£o da Tabela
        let tabelaHtml = '';
        if (operacoesComCalculo.length === 0) {
            tabelaHtml = '<p style="text-align:center;padding:20px;color:var(--muted);">Nenhum lan√ßamento encontrado. Importe um Excel ou adicione um manualmente.</p>';
        } else {
            const sortedOps = operacoesComCalculo.sort((a, b) => {
                // Ordena por data mais recente primeiro
                if (a.data < b.data) return 1;
                if (a.data > b.data) return -1;
                return 0;
            });
            
            tabelaHtml = `<table>
                <thead>
                    <th>A√ß√µes</th>
                    <th>Data</th>
                    <th class="col-left">Descri√ß√£o/Resumo</th>
                    <th>Banco</th>
                    <th>Conta Cedente</th>
                    <th>Conta Cession√°rio</th>
                    <th>Compromissada</th>
                    <th>Retorno Bruto</th>
                    <th>Taxa CDI (%)</th>
                    <th>Ganho (R$)</th>
                </thead>
                <tbody>
            `;

            sortedOps.forEach((op, index) => {
                const ganhoClass = op.ganho >= 0 ? 'ganho' : 'perda';
                
                tabelaHtml += `
                    <tr>
                        <td class="action-cell">
                            <button class="btn small" onclick="editOperation(${operacoes.indexOf(op)})">‚úèÔ∏è</button>
                            <button class="btn small secondary danger" onclick="deleteOperation(${operacoes.indexOf(op)})">‚úñÔ∏è</button>
                        </td>
                        <td>${formatDataBR(op.data)}</td>
                        <td class="col-left">${op.descricao}</td>
                        <td style="text-align:left;">${op.banco || '-'}</td>
                        <td style="text-align:right;">${op.cedente || '-'}</td>
                        <td style="text-align:right;">${op.cessionario || '-'}</td>
                        <td>${formatBRL(op.compromissada)}</td>
                        <td>${formatBRL(op.retorno)}</td>
                        <td>${formatPercent(op.taxaAplicada)}</td>
                        <td><span class="${ganhoClass}">${formatBRL(op.ganho)}</span></td>
                    </tr>
                `;
            });
            
            tabelaHtml += '</tbody></table>';
        }

        document.getElementById('resultTable').innerHTML = tabelaHtml;
    }
    
    // Fun√ß√µes CRUD (Adicionar, Editar, Deletar)
    function addOrUpdateOperation() {
        const index = parseInt(document.getElementById('editIndex').value);
        const data = document.getElementById('manualData').value;
        const descricao = document.getElementById('manualDesc').value;
        const banco = document.getElementById('manualBanco').value;
        const cedente = document.getElementById('manualCedente').value;
        const cessionario = document.getElementById('manualCessionario').value;
        const cdiTaxa = cleanCdiTaxa(document.getElementById('manualCdiTaxa').value);
        const compromissada = cleanCurrency(document.getElementById('manualCompromissada').value);
        const retorno = cleanCurrency(document.getElementById('manualRetorno').value);

        if (!data || !descricao || compromissada === 0 || retorno === 0) {
            log('Preencha Data, Descri√ß√£o, Valor Compromissada e Valor Retorno.');
            return;
        }

        const newOp = { data, descricao, banco, cedente, cessionario, cdiTaxa, compromissada, retorno, source: 'Manual' };

        if (index > -1 && index < operacoes.length) {
            operacoes[index] = newOp;
            log('‚úÖ Lan√ßamento editado com sucesso!');
        } else {
            operacoes.push(newOp);
            log('‚úÖ Novo lan√ßamento adicionado com sucesso!');
        }

        resetManualForm();
        calculateAndRender();
        saveState(); // Salva ap√≥s CRUD
    }

    function editOperation(index) {
        const op = operacoes[index];
        document.getElementById('editIndex').value = index;
        document.getElementById('manualData').value = op.data;
        document.getElementById('manualDesc').value = op.descricao;
        document.getElementById('manualBanco').value = op.banco;
        document.getElementById('manualCedente').value = op.cedente;
        document.getElementById('manualCessionario').value = op.cessionario;
        document.getElementById('manualCdiTaxa').value = formatPercent(op.cdiTaxa);
        document.getElementById('manualCompromissada').value = op.compromissada.toLocaleString('pt-BR');
        document.getElementById('manualRetorno').value = op.retorno.toLocaleString('pt-BR');
        
        document.getElementById('addBtn').textContent = 'Salvar Edi√ß√£o';
        document.getElementById('addBtn').classList.add('secondary');
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        log(`‚úèÔ∏è Editando lan√ßamento da data ${formatDataBR(op.data)}.`);
        window.scrollTo({ top: document.getElementById('input-panel').offsetTop, behavior: 'smooth' });
    }

    function deleteOperation(index) {
        if (confirm('Tem certeza que deseja excluir esta opera√ß√£o?')) {
            operacoes.splice(index, 1);
            log('üóëÔ∏è Lan√ßamento exclu√≠do.');
            calculateAndRender();
            saveState(); // Salva ap√≥s dele√ß√£o
        }
    }

    function resetManualForm() {
        document.getElementById('editIndex').value = -1;
        document.getElementById('manualData').value = '';
        document.getElementById('manualDesc').value = '';
        document.getElementById('manualBanco').value = '';
        document.getElementById('manualCedente').value = '';
        document.getElementById('manualCessionario').value = '';
        document.getElementById('manualCdiTaxa').value = '';
        document.getElementById('manualCompromissada').value = '';
        document.getElementById('manualRetorno').value = '';
        
        document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
        document.getElementById('addBtn').classList.remove('secondary');
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    // Event Listeners para CRUD Manual
    document.getElementById('addBtn').addEventListener('click', addOrUpdateOperation);
    document.getElementById('cancelEditBtn').addEventListener('click', resetManualForm);

    // L√≥gica de Filtro
    document.getElementById('filterBtn').addEventListener('click', () => {
        dataFiltroInicio = document.getElementById('filterStartDate').value;
        dataFiltroFim = document.getElementById('filterEndDate').value;
        filtroAtivo = true;
        calculateAndRender();
    });

    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        dataFiltroInicio = null;
        dataFiltroFim = null;
        filtroAtivo = false;
        calculateAndRender();
    });

    // L√≥gica do Bot√£o Excluir Tudo
    document.getElementById('deleteAllBtn').addEventListener('click', () => {
        if (confirm('ATEN√á√ÉO: Voc√™ realmente deseja APAGAR TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!')) {
            operacoes = [];
            resetManualForm();
            calculateAndRender();
            saveState(); // Salva o estado vazio no Firebase
            log('üóëÔ∏è Todos os dados foram exclu√≠dos permanentemente.');
        }
    });

    // L√≥gica do Bot√£o Exportar (Exemplo simples CSV/Excel)
    document.getElementById('exportBtn').addEventListener('click', () => {
        if (operacoes.length === 0) {
            log('N√£o h√° dados para exportar.');
            return;
        }

        const dataToExport = operacoes.map(op => ({
            Data: formatDataBR(op.data),
            Descricao: op.descricao,
            Banco: op.banco,
            'Conta Cedente': op.cedente,
            'Conta Cessionario': op.cessionario,
            Compromissada: op.compromissada,
            'Retorno Bruto': op.retorno,
            'Taxa CDI (%)': op.cdiTaxa,
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ganhos CDI");
        XLSX.writeFile(wb, "Controle_Ganhos_CDI.xlsx");
        log('‚úÖ Dados exportados para Controle_Ganhos_CDI.xlsx');
    });

    // L√≥gica do Bot√£o Imprimir
    document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
    });

    // Coloque aqui o restante do seu c√≥digo JavaScript (logo, etc.)
    
</script>
</body>
</html>
