<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        /* CSS OMITIDO POR BREVIDADE */
        :root{
            --primary: #0A0A33;
            --primary-light: #1A1A55;
            --secondary: #C00000;
            --secondary-light: #E00000;
            --danger: #c62828;
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        #siteLogo{ display:block; max-width:140px; width:100%; height:auto; border-radius:6px; box-shadow:var(--shadow); margin:0 0 6px 0;}
        #logo-wrapper{ margin-bottom:8px; }
        #header-container{ display:flex; align-items:center; gap:10px; margin-bottom:8px; width: fit-content; }
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); }
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        #left-header-content { display: flex; align-items: center; gap: 10px; }
        #top-actions{
            display:flex; align-items:center; gap:10px; padding:10px;
            background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border);
            flex-wrap:wrap;
        }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            background: var(--primary);
            color: white;
            border: 1px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        .btn.secondary { background: var(--secondary); color: white; border: 1px solid white; }
        .btn.small { padding: 6px 10px; font-size: 13px; border-radius: 7px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); background: var(--primary-light); border-color: white; }
        .btn.secondary:hover { background: var(--secondary-light); border-color: white; box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25); }
        .btn:active { transform: none; filter: brightness(0.96); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);}
        .btn.danger { background: var(--secondary); color: white; border: 1px solid white; box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25);}
        .btn.danger:hover { filter: brightness(0.85); border-color: white; }
        #main-container{ display:flex; flex-direction:column; gap:14px; align-items:stretch; }
        .card{ background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border); color:var(--text-dark); }
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"], input[type="email"], input[type="password"]{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px; }
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        #totalCdiDisplay p { color: var(--success) !important; }
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{ position:sticky; top:0; z-index:2; background: linear-gradient(180deg,var(--primary-light),var(--primary)); color:white; padding:10px 8px; text-align:left; font-weight:700; border-bottom:1px solid rgba(0,0,0,0.06); }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        .col-left{ text-align:left; max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: var(--primary); font-weight: 600; }
        .action-cell{ text-align:center; }
        .ganho, .perda { font-weight: 800; padding: 2px 6px; border-radius: 4px; display: inline-block; min-width: 60px; text-align: center;}
        .ganho { color: var(--success) !important; background: rgba(46, 125, 50, 0.1); border: 1px solid rgba(46, 125, 50, 0.2);}
        .perda { color: var(--danger) !important; background: rgba(198, 40, 40, 0.1); border: 1px solid rgba(198, 40, 40, 0.2);}
        b, strong { font-weight: 800; color: var(--primary); }
        @media (max-width:980px){
            #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; }
            #header-container{ margin-bottom:0; width: 100%; justify-content: center; }
            #left-header-content { justify-content: center; }
            .filter-card { margin-bottom: 12px !important; }
            .input-row{ flex-direction:column; align-items:stretch; }
        }
        @media print{
            body{ background:white; padding:0; color:black; }
            #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn, #auth-status { display:none; }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.mini.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

</head>

<body onload="loadLogo()">
    <div id="logo-wrapper">
        <img id="siteLogo" alt="Logo do site">
    </div>

    <div id="header-container">
        <div id="left-header-content">
            <div id="logo-placeholder">üìà</div>
            <h1>Controle de Ganhos CDI</h1>
        </div>
    </div>

    <div id="auth-status" class="card" style="padding: 10px; margin-bottom: 14px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; justify-content: space-between;">
        <span id="login-message" style="font-weight: 600;">Status: Desconectado</span>
        
        <div id="auth-controls" style="display: flex; gap: 8px; flex-wrap: wrap; width: 100%; max-width: 400px; margin-left: auto;">
            <input type="email" id="authEmail" placeholder="Email" class="small" style="flex: 1; min-width: 100px;">
            <input type="password" id="authPassword" placeholder="Senha" class="small" style="flex: 1; min-width: 100px;">
            <button id="loginBtn" class="btn small" style="flex: 1; min-width: 80px;">Login</button>
            <button id="signupBtn" class="btn small secondary" style="flex: 1; min-width: 80px;">Cadastrar</button>
        </div>
        <button id="logoutBtn" class="btn small danger" style="display:none;">Logout</button>
    </div>

    <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
        <div id="header-left">
            <div style="font-weight:700;">Resumo Di√°rio</div>
            <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
        </div>

        <div id="header-right">
            <button id="printBtn" class="btn small" title="Imprimir">Imprimir</button>
            <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>

            <label class="file-label" for="excelFile" title="Selecionar arquivos">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple>
                <span class="btn small">Procurar</span>
            </label>

            <button id="loadExcelBtn" class="btn small secondary" title="Importar arquivos">Importar</button>

            <label class="logo-label" for="logoFile" title="Carregar logo">
                <input type="file" id="logoFile" accept="image/*">
                <span class="btn small">Procurar</span>
            </label>

            <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo">Carregar Logo</button>
            <button id="removeLogoBtn" class="btn small" title="Remover">Remover</button>

            <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo">üóëÔ∏è</button>
        </div>
    </div>

    <div id="main-container">

        <div id="results-panel" class="card">
            <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>

            <div class="card filter-card" style="margin-bottom:10px;" aria-label="Op√ß√µes de Filtragem de Dados">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <div style="font-weight:600;color:var(--muted);">Filtros</div>
                    <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                </div>

                <div class="input-row" style="margin-top:8px;">
                    <div>
                        <label for="filterStartDate">Data de In√≠cio</label>
                        <input type="date" id="filterStartDate">
                    </div>

                    <div>
                        <label for="filterEndDate">Data de Fim</label>
                        <input type="date" id="filterEndDate">
                    </div>

                    <div style="display:flex;align-items:flex-end;gap:8px;">
                        <button id="filterBtn" class="btn small">Filtrar</button>
                        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-weight:600;color:var(--muted)">
                        <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                    </label>
                </div>
            </div>
            <div class="totals">
                <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
            </div>

            <div class="table-wrap">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th class="col-left">Descri√ß√£o/Resumo</th>
                            <th>Banco</th>
                            <th>Conta Cedente</th>
                            <th>Conta Cession√°rio</th>
                            <th>Compromissada</th>
                            <th>Retorno Bruto</th>
                            <th>PU Ida</th>
                            <th>PU Volta</th>
                            <th>Taxa CDI Anual (%)</th>
                            <th>Ganho (R$) Di√°rio</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>

            <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
            </p>
        </div>

        <div id="input-panel" class="card">
            <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>

            <div class="input-row">
                <div>
                    <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                    <input type="text" id="taxaCdiAnual" value="14,90" onchange="calculateAndRender()">
                </div>

                <div>
                    <label for="diasAno">Dias no Ano</label>
                    <input type="text" id="diasAno" value="252" onchange="calculateAndRender()">
                </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">

            <h3>üìÇ Importa√ß√£o</h3>
            <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                *O sistema prioriza as colunas **VL IDA** e **VL VOLTA** para os valores totais. **CONTRAPARTE** √© mapeado como Conta Cedente.
            </p>

            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">

            <h3>‚ûï Lan√ßamento Manual</h3>

            <div style="display:flex;flex-direction:column;gap:8px;">
                <input type="hidden" id="editIndex" value="-1">

                <div>
                    <label for="manualData">Data do Lan√ßamento</label>
                    <input type="date" id="manualData">
                </div>

                <div>
                    <label for="manualDesc">Descri√ß√£o</label>
                    <input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s">
                </div>

                <div>
                    <label for="manualBanco">Banco / Contraparte</label>
                    <input type="text" id="manualBanco" placeholder="Ex: BTG Pactual">
                </div>

                <div style="display:flex;gap:8px;">
                    <div style="flex:1;">
                        <label for="manualCedente">Conta Cedente</label>
                        <input type="text" id="manualCedente">
                    </div>
                    <div style="flex:1;">
                        <label for="manualCessionario">Conta Cession√°rio</label>
                        <input type="text" id="manualCessionario">
                    </div>
                </div>

                <div>
                    <label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label>
                    <input type="text" id="manualCdiTaxa">
                </div>

                <div style="display:flex;gap:8px;">
                    <div style="flex:1;">
                        <label for="manualCompromissada">Valor Compromissada</label>
                        <input type="text" id="manualCompromissada">
                    </div>
                    <div style="flex:1;">
                        <label for="manualRetorno">Valor Retorno (Bruto)</label>
                        <input type="text" id="manualRetorno">
                    </div>
                </div>

                <div style="display:flex;gap:8px;">
                    <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
                    <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
                </div>
            </div>
            <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
        </div>
    </div>

    <script>
        /* ============================================================
            CONFIGURA√á√ÉO DO FIREBASE (CHAVE RESTAURADA)
        ============================================================ */
        const firebaseConfig = {
            apiKey: "AIzaSyDr9_y_G762t9q933333333333333333333333333", // <-- CHAVE RECUPERADA
            authDomain: "controle-cdi.firebaseapp.com",
            databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
            projectId: "controle-cdi",
            storageBucket: "controle-cdi.firebasestorage.app",
            messagingSenderId: "215359645646",
            appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
            measurementId: "G-TV1M1QWQRC"
        };

        let operacoes = []; // Array principal para armazenar os dados
        let filteredOperacoes = []; // Array para armazenar os dados ap√≥s o filtro
        let database = null;
        let currentUserUid = null;
        const DB_ROOT_PATH = "usuarios/";
        let uploadedFiles = []; 

        const log = (message) => {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const currentLog = logElement.textContent.split('\n').slice(0, 4).join('\n');
            logElement.textContent = `[${timestamp}] ${message}\n` + currentLog;
        };

        if (typeof firebase !== 'undefined' && typeof firebase.database !== 'undefined' && typeof firebase.auth !== 'undefined') {
             try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                log("‚úÖ Firebase SDKs carregados. Inicializa√ß√£o OK.");
            } catch (e) {
                console.error("Erro ao inicializar o Firebase:", e);
                log(`‚ùå Erro de Configura√ß√£o: Verifique a 'apiKey' e o 'projectId'. Detalhe: ${e.message}`);
            }
        } else {
            console.error("Firebase SDKs n√£o carregados.");
            log("‚ùå Erro: Firebase SDKs n√£o carregados. Verifique as tags <script>.");
        }

        /* ============================================================
            FUN√á√ïES DE UTILIDADE
        ============================================================ */
        const cleanCurrency = (value) => {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            // Remove pontos (milhares), substitui v√≠rgula (decimal) por ponto, remove R$ e espa√ßos.
            return parseFloat(value.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
        };

        const parseNumber = (value) => {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') return cleanCurrency(value);
            return 0;
        };

        const formatBRL = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };

        const normalizeDate = (date) => {
            if (date instanceof Date && !isNaN(date)) {
                return date.toISOString().split('T')[0]; // yyyy-mm-dd
            }
            if (typeof date === 'number' && date > 1000) {
                // Excel base date (1899-12-30). Subtrair 1 (Excel bug) e ajustar o fuso.
                const d = new Date(Date.UTC(0, 0, date - 1));
                return d.toISOString().split('T')[0];
            }
            if (typeof date === 'string') {
                const parts = date.match(/(\d{1,2})[-/](\d{1,2})[-/](\d{4})/);
                if (parts) {
                    const d = new Date(parts[3], parts[2] - 1, parts[1]);
                    if (!isNaN(d)) return d.toISOString().split('T')[0];
                }
                let parsedDate = new Date(date);
                if (!isNaN(parsedDate)) {
                    return parsedDate.toISOString().split('T')[0];
                }
            }
            return ''; 
        };


        /* ============================================================
            L√ìGICA DE C√ÅLCULO E RENDERIZA√á√ÉO
        ============================================================ */

        function calculateAndRender(dataArray = operacoes) {
            const tableBody = document.getElementById('resultBody');
            tableBody.innerHTML = '';
            
            let totalCompromissada = 0;
            let totalRetornoBruto = 0;
            let totalCdiGain = 0;

            const globalCdiRate = parseNumber(document.getElementById('taxaCdiAnual').value);
            const showIndividualOps = document.getElementById('showIndividualOps').checked;

            filteredOperacoes = dataArray.sort((a, b) => new Date(a.data) - new Date(b.data));

            const dataToRender = showIndividualOps ? filteredOperacoes : aggregateData(filteredOperacoes);

            dataToRender.forEach((op) => {
                const taxaCdiAnual = op.taxaCdiAnual > 0 ? op.taxaCdiAnual : globalCdiRate;
                
                const ganhoDiario = op.retornoBruto - op.compromissada;

                totalCompromissada += op.compromissada;
                totalRetornoBruto += op.retornoBruto;
                totalCdiGain += ganhoDiario;

                const row = tableBody.insertRow();
                const formattedDate = op.data ? op.data.split('-').reverse().join('/') : 'N/A';
                const gainClass = ganhoDiario >= 0 ? 'ganho' : 'perda';
                const actionButtons = showIndividualOps ? 
                    `<button class="btn small" onclick="editOperation('${op.id}')">‚úèÔ∏è</button>
                     <button class="btn small danger" onclick="deleteOperation('${op.id}')">üóëÔ∏è</button>`
                    : '-'; 

                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td class="col-left" title="${op.descricao || ''}">${op.descricao || 'N/A'}</td>
                    <td>${op.banco || 'N/A'}</td>
                    <td>${op.contaCedente || 'N/A'}</td>
                    <td>${op.contaCessionario || 'N/A'}</td>
                    <td>${formatBRL(op.compromissada)}</td>
                    <td>${formatBRL(op.retornoBruto)}</td>
                    <td>${op.puIda > 0 ? formatBRL(op.puIda) : '-'}</td>
                    <td>${op.puVolta > 0 ? formatBRL(op.puVolta) : '-'}</td>
                    <td>${taxaCdiAnual > 0 ? taxaCdiAnual.toFixed(2) + '%' : '-'}</td>
                    <td class="${gainClass}">${formatBRL(ganhoDiario)}</td>
                    <td class="action-cell">${actionButtons}</td>
                `;
            });
            
            document.getElementById('totalCompromissadaDisplay').querySelector('p').textContent = formatBRL(totalCompromissada);
            document.getElementById('totalRetornoDisplay').querySelector('p').textContent = formatBRL(totalRetornoBruto);
            document.getElementById('totalCdiDisplay').querySelector('p').textContent = formatBRL(totalCdiGain);

            if (dataToRender.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="12" style="text-align:center;padding:20px;color:var(--muted);">Nenhuma opera√ß√£o encontrada nos filtros.</td>`;
            }
        }

        function aggregateData(data) {
             return data;
        }

        /* ============================================================
            L√ìGICA CRUD MANUAL (ADI√á√ÉO, EDI√á√ÉO, EXCLUS√ÉO)
        ============================================================ */
        const clearManualInputs = () => {
            document.getElementById('editIndex').value = '-1';
            document.getElementById('manualData').value = '';
            document.getElementById('manualDesc').value = '';
            document.getElementById('manualBanco').value = '';
            document.getElementById('manualCedente').value = '';
            document.getElementById('manualCessionario').value = '';
            document.getElementById('manualCdiTaxa').value = '';
            document.getElementById('manualCompromissada').value = '';
            document.getElementById('manualRetorno').value = '';

            document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
            document.getElementById('cancelEditBtn').style.display = 'none';
        };

        const validateManualInput = () => {
            const data = document.getElementById('manualData').value;
            const desc = document.getElementById('manualDesc').value;
            const compromissada = cleanCurrency(document.getElementById('manualCompromissada').value);
            const retorno = cleanCurrency(document.getElementById('manualRetorno').value);

            if (!data || !desc || compromissada === 0 || retorno === 0) {
                log("‚ö†Ô∏è Preencha Data, Descri√ß√£o, Valor Compromissada e Valor Retorno.");
                return null;
            }

            return {
                id: document.getElementById('editIndex').value === '-1' ? Date.now() + Math.random() : document.getElementById('editIndex').value,
                data: data,
                descricao: desc,
                banco: document.getElementById('manualBanco').value,
                contaCedente: document.getElementById('manualCedente').value,
                contaCessionario: document.getElementById('manualCessionario').value,
                compromissada: compromissada,
                retornoBruto: retorno,
                puIda: 0, 
                puVolta: 0,
                taxaCdiAnual: parseNumber(document.getElementById('manualCdiTaxa').value),
                origem: 'Manual'
            };
        };

        document.getElementById('addBtn').addEventListener('click', () => {
            const newOp = validateManualInput();
            if (!newOp) return;

            const editId = document.getElementById('editIndex').value;

            if (editId !== '-1' && operacoes.some(op => op.id == editId)) {
                const index = operacoes.findIndex(op => op.id == editId);
                if (index > -1) {
                    operacoes[index] = newOp;
                    log(`‚úÖ Opera√ß√£o ID ${editId.toString().substring(0, 5)}... atualizada.`);
                }
            } else {
                operacoes.push(newOp);
                log(`‚úÖ Lan√ßamento manual adicionado: ${newOp.descricao}.`);
            }
            
            clearManualInputs();
            calculateAndRender();
            saveState(); 
        });

        document.getElementById('cancelEditBtn').addEventListener('click', clearManualInputs);
        
        window.editOperation = (id) => {
            const op = operacoes.find(o => o.id == id);
            if (!op) return;

            document.getElementById('editIndex').value = op.id;
            document.getElementById('manualData').value = op.data;
            document.getElementById('manualDesc').value = op.descricao;
            document.getElementById('manualBanco').value = op.banco;
            document.getElementById('manualCedente').value = op.contaCedente;
            document.getElementById('manualCessionario').value = op.contaCessionario;
            document.getElementById('manualCdiTaxa').value = op.taxaCdiAnual.toString().replace('.', ',');
            document.getElementById('manualCompromissada').value = op.compromissada.toFixed(2).replace('.', ',');
            document.getElementById('manualRetorno').value = op.retornoBruto.toFixed(2).replace('.', ',');

            document.getElementById('addBtn').textContent = 'Salvar Edi√ß√£o';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            log(`Modo Edi√ß√£o ativado para opera√ß√£o ID ${id.toString().substring(0, 5)}...`);
        };

        window.deleteOperation = (id) => {
            if (confirm('Tem certeza que deseja excluir esta opera√ß√£o?')) {
                operacoes = operacoes.filter(op => op.id != id);
                log(`‚ùå Opera√ß√£o ID ${id.toString().substring(0, 5)}... exclu√≠da.`);
                calculateAndRender();
                saveState();
                clearManualInputs(); 
            }
        };

        document.getElementById('deleteAllBtn').addEventListener('click', () => {
             if (confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja excluir *TODAS* as opera√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) {
                operacoes = [];
                log('üóëÔ∏è Todas as opera√ß√µes foram exclu√≠das.');
                calculateAndRender();
                saveState();
             }
        });


        /* ============================================================
            FUN√á√ïES DE PERSIST√äNCIA (LOAD/SAVE/FILTER)
        ============================================================ */
        function saveState(){
            if (!database || !currentUserUid) {
                log("‚ùå √â necess√°rio fazer login para salvar os dados.");
                return;
            }
            const stateToSave = {
                operacoes: operacoes,
                taxaCdiAnual: document.getElementById('taxaCdiAnual').value,
                diasAno: document.getElementById('diasAno').value
            };
            database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).set(stateToSave)
                .then(() => {
                    log(`‚úÖ ${operacoes.length} opera√ß√µes e configura√ß√µes salvas de forma segura!`);
                })
                .catch((error) => {
                    log(`‚ùå Erro ao salvar: ${error.message}.`);
                });
        }
        
        function loadStateFromFirebase(){
            if (!database || !currentUserUid) { 
                operacoes = []; 
                calculateAndRender(); 
                return;
            }
            database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).once('value')
                .then((snapshot) => {
                    const savedState = snapshot.val();
                    if (savedState && savedState.operacoes) {
                        operacoes = (savedState.operacoes || []).map(op => ({...op, id: op.id || Date.now() + Math.random()}));
                        document.getElementById('taxaCdiAnual').value = savedState.taxaCdiAnual || '14,90';
                        document.getElementById('diasAno').value = savedState.diasAno || '252';
                        log(`üíæ ${operacoes.length} opera√ß√µes carregadas com sucesso!`);
                    } else {
                        operacoes = [];
                        log('Nenhum dado salvo encontrado para este usu√°rio.');
                    }
                    calculateAndRender(); 
                })
                .catch(error => {
                    operacoes = [];
                    log(`‚ùå Erro ao carregar dados: ${error.message}`);
                    calculateAndRender();
                });
        }
        
        document.getElementById('filterBtn').addEventListener('click', () => {
            const startDateStr = document.getElementById('filterStartDate').value;
            const endDateStr = document.getElementById('filterEndDate').value;
            
            const startDate = startDateStr ? new Date(startDateStr + 'T00:00:00') : null;
            const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59') : null; 

            const filtered = operacoes.filter(op => {
                const opDate = new Date(op.data + 'T00:00:00'); 
                const matchStart = !startDate || opDate >= startDate;
                const matchEnd = !endDate || opDate <= endDate;
                return matchStart && matchEnd;
            });

            calculateAndRender(filtered);
            log(`Filtro aplicado. ${filtered.length} opera√ß√µes encontradas.`);
        });

        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            calculateAndRender();
            log('Filtros de data removidos.');
        });


        /* ============================================================
            L√ìGICA DE IMPORTA√á√ÉO DE ARQUIVOS (XLSX) - DESCRI√á√ÉO CORRIGIDA
        ============================================================ */
        
        function findDateColumn(row) {
            if (!row || typeof row !== 'object') return null;
            const possibleKeys = [
                'Data', 'DATA', 'Dt', 'DT', 'Data Opera√ß√£o', 'DATA OPERACAO', 'DT_OPERACAO', 
                'DT OPERA√á√ÉO', 'Vencimento', 'VENCIMENTO', 'Data Vencimento', 'DATA VENCIMENTO'
            ];

            for (const key of possibleKeys) {
                if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                    return row[key];
                }
            }

            for (const value of Object.values(row)) {
                if (typeof value === 'number' && value > 40000 && value < 60000) {
                    return value;
                }
                if (typeof value === 'string' && /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/.test(value)) {
                    return value;
                }
            }
            return null;
        }

        const mapExcelToOperation = (row, fileOriginName = 'Importa√ß√£o Desconhecida') => {
            const rawDate = findDateColumn(row);
            const dateValue = normalizeDate(rawDate);
            
            const findValue = (keys) => {
                for (const key of keys) {
                    if (row[key] !== undefined) return parseNumber(row[key]);
                }
                return 0;
            };

            const compromissadaValue = findValue(['VL IDA', 'VL_IDA', 'VALOR IDA', 'Compromissada', 'COMPROMISSADA', 'Valor']);
            const retornoValue = findValue(['VL VOLTA', 'VL_VOLTA', 'VALOR VOLTA', 'Retorno Bruto', 'RETORNO BRUTO', 'Valor']);
            
            // L√≥gica de fallback da descri√ß√£o para resolver seu problema anterior
            const desc = row['DESCRICAO'] || row['Resumo'] || row['HISTORICO'] || row['NOME'] || fileOriginName; 
            const contraparte = row['CONTRAPARTE'] || row['Contraparte'] || row['BANCO'] || '';

            return {
                id: Date.now() + Math.random(), 
                data: dateValue,
                descricao: desc.toString().trim(), 
                banco: contraparte,
                contaCedente: contraparte, 
                contaCessionario: row['Conta Cession√°rio'] || row['CONTA CESSIONARIO'] || '',
                compromissada: compromissadaValue,
                retornoBruto: retornoValue,
                puIda: findValue(['PU IDA', 'PU_IDA']),
                puVolta: findValue(['PU VOLTA', 'PU_VOLTA']),
                taxaCdiAnual: findValue(['TAXA CDI', 'Taxa CDI']),
                origem: 'Importa√ß√£o'
            };
        };


        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        const rawJson = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (rawJson.length === 0) {
                            return resolve([]);
                        }

                        const headers = rawJson[0].map(h => typeof h === 'string' ? h.toUpperCase().replace(/\s/g, '_') : h);
                        const dataRows = rawJson.slice(1);
                        
                        const json = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, i) => {
                                obj[header] = row[i];
                            });
                            return obj;
                        });

                        const newOperations = json.map(row => mapExcelToOperation(row, file.name));
                        resolve(newOperations);

                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }


        document.getElementById('excelFile').addEventListener('change', (e) => {
            uploadedFiles = Array.from(e.target.files);
            log(`${uploadedFiles.length} arquivo(s) selecionado(s).`);
        });

        document.getElementById('loadExcelBtn').addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                log("‚ö†Ô∏è Nenhum arquivo selecionado. Clique em 'Procurar' primeiro.");
                return;
            }
            if (!currentUserUid) {
                 log("‚ùå Voc√™ precisa estar logado para importar dados.");
                 return;
            }

            let totalImported = 0;
            log(`Iniciando importa√ß√£o de ${uploadedFiles.length} arquivo(s)...`);

            for (const file of uploadedFiles) {
                try {
                    const newOps = await readExcelFile(file);
                    
                    const uniqueNewOps = newOps.filter(newOp => 
                        !operacoes.some(existingOp => existingOp.data === newOp.data && existingOp.compromissada === newOp.compromissada && existingOp.retornoBruto === newOp.retornoBruto)
                    );

                    operacoes.push(...uniqueNewOps);
                    totalImported += uniqueNewOps.length;
                    log(`Arquivo "${file.name}": ${uniqueNewOps.length} opera√ß√µes importadas.`);

                } catch (error) {
                    log(`‚ùå Erro ao processar o arquivo "${file.name}": ${error.message}`);
                }
            }

            if (totalImported > 0) {
                log(`‚úÖ Importa√ß√£o conclu√≠da. Total de ${totalImported} novas opera√ß√µes adicionadas.`);
                document.getElementById('excelFile').value = ''; 
                uploadedFiles = [];
                calculateAndRender();
                saveState();
            } else {
                 log("Nenhuma nova opera√ß√£o v√°lida encontrada para importa√ß√£o.");
            }
        });


        /* ============================================================
            L√ìGICA DE LOGIN / LOGOUT / CADASTRO
        ============================================================ */
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginMessage = document.getElementById("login-message");
        const authControls = document.getElementById("auth-controls");
        const authEmail = document.getElementById("authEmail");
        const authPassword = document.getElementById("authPassword");

        loginBtn.addEventListener("click", () => {
            if (!database) { log("‚ùå Firebase n√£o inicializado. Verifique a configura√ß√£o."); return; }
            if (currentUserUid) {
                firebase.auth().signOut();
                return;
            }
            const email = authEmail.value.trim();
            const password = authPassword.value;
            if (!email || !password) {
                log("‚ö†Ô∏è Preencha email e senha para fazer login.");
                return;
            }
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => { log("‚úÖ Login realizado com sucesso."); })
                .catch(error => { 
                    if (error.code === 'auth/user-not-found') {
                        log("‚ö†Ô∏è Usu√°rio n√£o encontrado. Clique em 'Cadastrar'.");
                    } else if (error.code === 'auth/wrong-password') {
                        log("‚ùå Senha incorreta.");
                    } else {
                        log(`‚ùå Erro no Login: ${error.message}`); 
                    }
                });
        });

        signupBtn.addEventListener("click", () => {
            if (!database) { log("‚ùå Firebase n√£o inicializado. Verifique a configura√ß√£o."); return; }
            const email = authEmail.value.trim();
            const password = authPassword.value;
            if (!email || !password) {
                log("‚ö†Ô∏è Preencha email e senha para cadastrar.");
                return;
            }
            if (password.length < 6) {
                log("‚ùå A senha deve ter no m√≠nimo 6 caracteres.");
                return;
            }
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(() => { log("‚úÖ Cadastro realizado com sucesso e login autom√°tico."); })
                .catch(error => { log(`‚ùå Erro no Cadastro: ${error.message}`); });
        });

        logoutBtn.addEventListener("click", () => {
            if (!database) { log("‚ùå Firebase n√£o inicializado."); return; }
            firebase.auth().signOut()
                .then(() => { log("üëã Desconectado."); })
                .catch(error => { log(`‚ùå Erro no Logout: ${error.message}`); });
        });

        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUserUid = user.uid;
                    loginMessage.textContent = `Status: Conectado como ${user.email || 'Usu√°rio Autenticado'}`; 
                    
                    authControls.style.display = 'none';
                    logoutBtn.style.display = 'inline-block';
                    loginBtn.style.display = 'none';
                    signupBtn.style.display = 'none';

                    loadStateFromFirebase(); 
                } else {
                    currentUserUid = null;
                    loginMessage.textContent = "Status: Desconectado";
                    
                    authControls.style.display = 'flex';
                    logoutBtn.style.display = 'none';
                    loginBtn.style.display = 'inline-block';
                    signupBtn.style.display = 'inline-block';

                    operacoes = [];
                    calculateAndRender();
                    log('Aguardando Login/Cadastro para acessar os dados da nuvem.');
                }
            });
        }


        /* ============================================================
            L√ìGICA DE LOGO, PRINT E EXPORT
        ============================================================ */
        function loadLogo() {
            document.getElementById('siteLogo').style.display = 'none';
        }

        document.getElementById('addLogoBtn').addEventListener('click', () => {
             log("A l√≥gica de 'Carregar Logo' precisa ser implementada.");
        });

        document.getElementById('removeLogoBtn').addEventListener('click', () => {
             log("A l√≥gica de 'Remover Logo' precisa ser implementada.");
        });

        document.getElementById('printBtn').addEventListener('click', () => window.print());

        document.getElementById('exportBtn').addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(filteredOperacoes.map(op => ({
                Data: op.data,
                Descricao: op.descricao,
                Banco: op.banco,
                'Conta Cedente': op.contaCedente,
                'Conta Cessionario': op.contaCessionario,
                Compromissada: op.compromissada,
                'Retorno Bruto': op.retornoBruto,
                'PU Ida': op.puIda,
                'PU Volta': op.puVolta,
                'Taxa CDI Anual (%)': op.taxaCdiAnual,
                'Ganho (R$) Di√°rio': op.retornoBruto - op.compromissada,
                Origem: op.origem
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ganhos CDI");
            XLSX.writeFile(wb, "ControleGanhosCDI.xlsx");
            log("‚úÖ Dados exportados para ControlesGanhosCDI.xlsx");
        });

        
    </script>
</body>
</html>
