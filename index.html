<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Ganhos CDI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f2f2f2;
    margin:0;
    padding:0;
}
header{
    background:#2c2c2c;
    color:#fff;
    padding:10px 20px;
    display:flex;
    align-items:center;
    gap:15px;
}
header h1{
    font-size:20px;
    margin:0;
}
.container{
    padding:20px;
}
button{
    padding:6px 12px;
    cursor:pointer;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #ccc;
    padding:6px;
    font-size:12px;
}
th{
    background:#0b1c3d;
    color:#fff;
}
.total-box{
    display:flex;
    gap:20px;
    margin-top:10px;
}
.total{
    background:#fff;
    padding:10px;
    border-radius:6px;
    min-width:200px;
}
</style>
</head>

<body>

<header>
    <h1>Controle de Ganhos CDI</h1>
</header>

<div class="container">

    <div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <button id="importBtn">Importar</button>
    </div>

    <div class="total-box">
        <div class="total">
            <strong>Compromissada TOTAL</strong><br>
            <span id="totalComp">R$ 0,00</span>
        </div>
        <div class="total">
            <strong>Retorno Bruto TOTAL</strong><br>
            <span id="totalRet">R$ 0,00</span>
        </div>
        <div class="total">
            <strong>Ganho TOTAL</strong><br>
            <span id="totalGanho">R$ 0,00</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Banco</th>
                <th>Compromissada</th>
                <th>Retorno Bruto</th>
                <th>Ganho</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

</div>

<script>
/* =========================
   VARIÁVEIS GLOBAIS
========================= */
let operacoes = [];

/* =========================
   FUNÇÕES AUXILIARES
========================= */
function normalizeHeader(str){
    return String(str || "")
        .toUpperCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^A-Z0-9]/g, "");
}

function normalizeDate(s){
    if(!s) return "";

    if (typeof s === "number") {
        const d = XLSX.SSF.parse_date_code(s);
        if (d) {
            return `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
        }
    }

    s = String(s).trim();

    if (s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;

    if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        const [d,m,y] = s.split("/");
        return `${y}-${m}-${d}`;
    }

    return "";
}

function parseNumber(v){
    if(v===null || v===undefined) return 0;
    return Number(String(v).replace(/\./g,"").replace(",", ".")) || 0;
}

function formatBR(v){
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* =========================
   IMPORTAÇÃO EXCEL
========================= */
function processExcelData(data){
    const wb = XLSX.read(data,{type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});

    if(!rows.length){
        alert("Arquivo vazio");
        return;
    }

    const headers = rows[0].map(h => normalizeHeader(h));
    const map = {};

    const known = {
        "DTINICIO":"data",
        "PUIDA":"puIda",
        "PUVOLTA":"puVolta",
        "QUANTIDADE":"quantidade",
        "TX252":"cdiTaxa",
        "VEICULOLEGAL":"banco"
    };

    headers.forEach((h,i)=>{
        if(known[h]) map[known[h]] = i;
    });

    const novos = [];

    for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if(!r || !r[map.data]) continue;

        const puIda = parseNumber(r[map.puIda]);
        const puVolta = parseNumber(r[map.puVolta]);
        const qtd = parseNumber(r[map.quantidade] || 1);

        novos.push({
            data: normalizeDate(r[map.data]),
            banco: r[map.banco] || "",
            compromissada: puIda * qtd,
            retornoBruto: puVolta * qtd
        });
    }

    operacoes = operacoes.concat(novos);
    render();
    alert(`${novos.length} operações importadas com sucesso!`);
}
/* =========================
   RENDERIZAÇÃO
========================= */
function render(){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    let totalComp = 0;
    let totalRet = 0;

    operacoes.forEach(op=>{
        totalComp += op.compromissada;
        totalRet += op.retornoBruto;

        const tr = document.createElement("tr");

        const ganho = op.retornoBruto - op.compromissada;

        tr.innerHTML = `
            <td>${op.data}</td>
            <td>${op.banco}</td>
            <td>${formatBR(op.compromissada)}</td>
            <td>${formatBR(op.retornoBruto)}</td>
            <td>${formatBR(ganho)}</td>
        `;

        tbody.appendChild(tr);
    });

    document.getElementById("totalComp").innerText = formatBR(totalComp);
    document.getElementById("totalRet").innerText = formatBR(totalRet);
    document.getElementById("totalGanho").innerText = formatBR(totalRet - totalComp);
}

/* =========================
   EVENTOS
========================= */
document.getElementById("importBtn").addEventListener("click", ()=>{
    const input = document.getElementById("fileInput");
    if(!input.files.length){
        alert("Selecione um arquivo");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => processExcelData(e.target.result);
    reader.readAsArrayBuffer(input.files[0]);
});
/* =========================
   IMPORTAÇÃO EXCEL (CORRIGIDA)
========================= */
function normalizeHeader(h){
    if(!h) return "";
    return String(h)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .toUpperCase()
        .trim();
}

function normalizeDate(s){
    if(!s) return "";

    // Data numérica do Excel
    if(typeof s === "number"){
        const d = XLSX.SSF.parse_date_code(s);
        if(d){
            return `${d.y}-${String(d.m).padStart(2,"0")}-${String(d.d).padStart(2,"0")}`;
        }
    }

    s = String(s).trim();

    if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;

    if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
        const [d,m,y] = s.split("/");
        return `${y}-${m}-${d}`;
    }

    return "";
}

function processExcelData(data){
    const workbook = XLSX.read(data,{type:"array"});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});

    if(!json.length){
        alert("Arquivo vazio");
        return;
    }

    const headers = json[0].map(h => normalizeHeader(h));
    const map = {};

    const known = {
        "DATA":"data",
        "BANCO":"banco",
        "COMPROMISSADA":"compromissada",
        "RETORNO BRUTO":"retornoBruto"
    };

    headers.forEach((h,i)=>{
        if(known[h]) map[known[h]] = i;
    });

    let novos = 0;

    for(let i=1;i<json.length;i++){
        const row = json[i];
        if(!row || !row[map.data] || !row[map.compromissada]) continue;

        operacoes.push({
            data: normalizeDate(row[map.data]),
            banco: row[map.banco] || "",
            compromissada: Number(row[map.compromissada]) || 0,
            retornoBruto: Number(row[map.retornoBruto]) || 0
        });

        novos++;
    }

    render();
    alert(`${novos} registros importados com sucesso`);
}

/* =========================
   INICIALIZAÇÃO
========================= */
render();
</script>

</body>
</html>
