<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Ganhos CDI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.mini.min.js"></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px }
.card { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px }
table { width:100%; border-collapse:collapse }
th,td { padding:8px; border-bottom:1px solid #ddd; text-align:right }
th { background:#0A0A33; color:#fff }
td:first-child, th:first-child { text-align:center }
button { padding:6px 10px; cursor:pointer }
input { padding:6px }
#siteLogo { max-width:150px; margin-bottom:10px }
.ganho { color:green; font-weight:bold }
.perda { color:red; font-weight:bold }
</style>
</head>

<body>

<img id="siteLogo" style="display:none">

<div class="card">
<b>Status:</b> <span id="login-message">Desconectado</span><br><br>
<input id="authEmail" placeholder="Email">
<input id="authPassword" type="password" placeholder="Senha">
<button id="loginBtn">Login</button>
<button id="signupBtn">Cadastrar</button>
<button id="logoutBtn" style="display:none">Logout</button>
</div>

<div class="card">
<input type="file" id="excelFile">
<button id="importBtn">Importar Excel</button>
</div>

<div class="card">
<input type="file" id="logoFile">
<button id="logoBtn">Salvar Logo</button>
<button id="removeLogoBtn">Remover Logo</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Data</th>
<th>Descrição</th>
<th>Compromissada</th>
<th>Retorno</th>
<th>Ganho</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
 apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
 authDomain: "controle-cdi.firebaseapp.com",
 databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
 projectId: "controle-cdi",
 storageBucket: "controle-cdi.firebasestorage.app"
});

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let uid = null;
let operacoes = [];

/* UTIL */
const clean = v => {
 if(typeof v === 'number') return Number(v.toFixed(2));
 if(typeof v === 'string')
   return parseFloat(v.replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''))||0;
 return 0;
};
const format = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* AUTH */
loginBtn.onclick = () => auth.signInWithEmailAndPassword(authEmail.value,authPassword.value);
signupBtn.onclick = () => auth.createUserWithEmailAndPassword(authEmail.value,authPassword.value);
logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user=>{
 if(user){
  uid=user.uid;
  login-message.textContent="Conectado";
  logoutBtn.style.display='inline';
  load();
  loadLogo();
 }else{
  uid=null;
  operacoes=[];
  render();
 }
});

/* SAVE / LOAD */
function save(){
 db.ref("usuarios/"+uid).set({operacoes});
}
function load(){
 db.ref("usuarios/"+uid).once("value").then(s=>{
  operacoes=s.val()?.operacoes||[];
  render();
 });
}

/* RENDER */
function render(){
 tbody.innerHTML='';
 operacoes.forEach(o=>{
  const ganho=o.retorno-o.comp;
  tbody.innerHTML+=`
   <tr>
    <td>${o.data}</td>
    <td>${o.desc}</td>
    <td>${format(o.comp)}</td>
    <td>${format(o.retorno)}</td>
    <td class="${ganho>=0?'ganho':'perda'}">${format(ganho)}</td>
   </tr>`;
 });
}

/* IMPORT */
importBtn.onclick=()=>{
 const f=excelFile.files[0];
 const r=new FileReader();
 r.onload=e=>{
  const wb=XLSX.read(e.target.result,{type:'binary'});
  const ws=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  ws.forEach(row=>{
   operacoes.push({
    data: row.Data || '',
    desc: row.Descrição || 'Excel',
    comp: clean(row['VL IDA']),
    retorno: clean(row['VL VOLTA'])
   });
  });
  save(); render();
 };
 r.readAsBinaryString(f);
};

/* LOGO */
logoBtn.onclick=()=>{
 const f=logoFile.files[0];
 const ref=storage.ref("logos/"+uid+".png");
 ref.put(f).then(()=>ref.getDownloadURL()).then(url=>{
  db.ref("usuarios/"+uid+"/logo").set(url);
  siteLogo.src=url; siteLogo.style.display='block';
 });
};
removeLogoBtn.onclick=()=>{
 db.ref("usuarios/"+uid+"/logo").remove();
 siteLogo.style.display='none';
};
function loadLogo(){
 db.ref("usuarios/"+uid+"/logo").once("value").then(s=>{
  if(s.val()){ siteLogo.src=s.val(); siteLogo.style.display='block'; }
 });
}
</script>
</body>
</html>
