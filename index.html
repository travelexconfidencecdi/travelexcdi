<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle de Ganho CDI - C√°lculo Di√°rio c/ Persist√™ncia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1100px;
            margin: auto;
        }
        h1 {
            text-align: center;
        }
        .logo-box {
            width: 200px;
            height: 200px;
            border: 2px dashed #999;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: white;
            margin: auto;
            cursor: pointer;
        }
        .logo-box img {
            max-width: 100%;
            max-height: 100%;
        }
        .btn {
            padding: 10px 22px;
            margin: 6px;
            border: none;
            background: #1976d2;
            color: white;
            cursor: pointer;
            border-radius: 6px;
        }
        .btn:disabled {
            background: gray;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #c62828;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-top: 25px;
        }
        .col {
            flex: 1;
        }
        .log-box {
            height: 180px;
            overflow-y: auto;
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        .table-box {
            margin-top: 25px;
            background: #fff;
            padding: 15px;
            border-radius: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ccc;
        }
        th {
            background: #e0e0e0;
        }
    </style>
</head>

<body>
<div class="container">

    <h1>Controle de Ganho CDI - C√°lculo Di√°rio</h1>

    <h3 style="text-align:center">Logo da Empresa</h3>

    <div class="logo-box" id="logoBox">
        <span>Clique para adicionar logo</span>
    </div>

    <div style="text-align:center; margin-top:10px;">
        <button id="removeLogoBtn" class="btn btn-danger">Remover Logo</button>
    </div>

    <br>

    <h3>Importar Arquivo Excel</h3>

    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button id="loadExcelBtn" class="btn">Importar</button>

    <div class="row">
        <div class="col">
            <h3>Log do Sistema</h3>
            <div id="logBox" class="log-box"></div>
        </div>
    </div>

    <div class="table-box">
        <h3>Opera√ß√µes Importadas</h3>
        <table id="opsTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Banco</th>
                    <th>Cedente</th>
                    <th>Cession√°rio</th>
                    <th>Compromissada</th>
                    <th>Retorno Bruto</th>
                    <th>PU Ida</th>
                    <th>PU Volta</th>
                    <th>Taxa CDI</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ==========================
   LOG
========================== */
function log(msg) {
    const box = document.getElementById('logBox');
    box.innerHTML += msg + "<br>";
    box.scrollTop = box.scrollHeight;
}

/* ==========================
   PERSIST√äNCIA DO LOGO
========================== */
window.addEventListener('load', () => {
    const savedLogo = localStorage.getItem('empresaLogo');
    const logoBox = document.getElementById('logoBox');

    if (savedLogo) {
        logoBox.innerHTML = `<img src="${savedLogo}">`;
    }
});

const logoBox = document.getElementById('logoBox');
logoBox.addEventListener('click', () => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';

    inp.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const base64 = event.target.result;
            localStorage.setItem('empresaLogo', base64);
            logoBox.innerHTML = `<img src="${base64}">`;
        };
        reader.readAsDataURL(file);
    };

    inp.click();
});

const removeLogoBtn = document.getElementById('removeLogoBtn');
if (removeLogoBtn) {
    removeLogoBtn.addEventListener('click', () => {
        if (!confirm("Tem certeza que deseja remover a logo?")) return;
        localStorage.removeItem('empresaLogo');
        logoBox.innerHTML = "<span>Clique para adicionar logo</span>";
    });
}

/* ==========================
   VARI√ÅVEIS PRINCIPAIS
========================== */
let operacoes = [];

function formatDataBR(d) {
    if (!d) return '';
    if (typeof d === 'object') {
        return d.toLocaleDateString('pt-BR');
    }
    return d;
}

function cleanCdiTaxa(t) {
    if (!t) return '';
    return String(t).replace('%','').trim();
}

function parseNumber(v) {
    if (!v || v === "") return "";
    return Number(String(v).replace(",", "."));
}

/* ==========================
   EXCEL READER
========================== */
async function loadExcel(file) {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, { header: 1 });
}

function processExcel(rows) {

    // √≠ndices
    const indices = {
        DESCRICAO: 0,
        BANCO: 1,
        CEDENTE: 2,
        CESSIONARIO: 3,
        COMP: 4,
        RET: 5,
        PU_IDA: 6,
        PU_VOLTA: 7,
        TAXA: 8,
        DATA: 9
    };

    let newOps = [];
    let valid = 0;

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row.length) continue;

        let rawData = row[indices.DATA];
        let dataFormatada = rawData ? new Date(rawData) : "";

        newOps.push({
            data: dataFormatada,
            descricao: String(row[indices.DESCRICAO] || ''),
            banco: String(row[indices.BANCO] || ''),
            contaCedente: String(row[indices.CEDENTE] || ''),
            contaCessionario: String(row[indices.CESSIONARIO] || ''),
            compromissada: String(row[indices.COMP] || ''),
            retorno: String(row[indices.RET] || ''),
            puIda: String(row[indices.PU_IDA] || ''),
            puVolta: String(row[indices.PU_VOLTA] || ''),
            cdiTaxa: String(row[indices.TAXA] || '')
        });

        valid++;
    }

    log(`‚úÖ ${valid} opera√ß√µes v√°lidas encontradas e prontas para importa√ß√£o.`);
    return newOps;
}

/* ==========================
   RENDERIZA√á√ÉO DA TABELA
========================== */
function renderTable() {
    const tbody = document.querySelector("#opsTable tbody");
    tbody.innerHTML = "";

    operacoes.forEach(op => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDataBR(op.data)}</td>
            <td>${op.descricao}</td>
            <td>${op.banco}</td>
            <td>${op.contaCedente}</td>
            <td>${op.contaCessionario}</td>
            <td>${op.compromissada}</td>
            <td>${op.retorno}</td>
            <td>${op.puIda}</td>
            <td>${op.puVolta}</td>
            <td>${op.cdiTaxa}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ==========================
   IMPORTA√á√ÉO ‚Äî CORRE√á√ÉO AQUI!
========================== */
const fileInput = document.getElementById('excelFile');
const loadBtn   = document.getElementById('loadExcelBtn');

loadBtn.addEventListener('click', async () => {

    const files = fileInput.files;
    if (files.length === 0) {
        alert("Selecione um arquivo.");
        return;
    }

    log(`‚è≥ Processando ${files.length} arquivo(s)...`);

    let totalNewOps = [];

    for (const file of files) {
        try {
            const data = await loadExcel(file);
            const newOps = processExcel(data);
            totalNewOps = totalNewOps.concat(newOps);

            log(`üìÅ "${file.name}" processado. ${newOps.length} opera√ß√µes.`);
        } catch (e) {
            log(`‚ùå Erro ao processar "${file.name}".`);
        }
    }

    if (totalNewOps.length > 0) {
        operacoes = operacoes.concat(totalNewOps);
        renderTable();
        log(`üéâ Importa√ß√£o conclu√≠da! Total: ${operacoes.length}.`);
    } else {
        log('‚ö†Ô∏è Nenhuma opera√ß√£o v√°lida encontrada.');
    }

    fileInput.value = '';
});
</script>

</body>
</html>
