<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle de Ganho CDI - C√°lculo Di√°rio c/ Persist√™ncia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
            background: #f7f7f7;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .flex {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .flex > div {
            flex: 1;
            min-width: 150px;
        }

        label {
            font-weight: bold;
        }

        input, button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th {
            background: #eee;
            padding: 10px;
        }

        td {
            padding: 8px;
        }

        .log {
            background: #222;
            color: #0f0;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            border-radius: 5px;
        }

        .button {
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            border-radius: 4px;
        }

        .button.import { background: #4CAF50; color: white; }
        .button.calc { background: #2196F3; color: white; }
        .button.export { background: #FF9800; color: white; }
        .button.clear { background: #f44336; color: white; }
    </style>
</head>
<body>

<h1>Controle de Ganho CDI</h1>

<div class="panel">

    <h2>Filtro de Datas</h2>
    <div class="flex">
        <div>
            <label>Data In√≠cio:</label>
            <input type="date" id="dataInicio">
        </div>
        <div>
            <label>Data Fim:</label>
            <input type="date" id="dataFim">
        </div>
    </div>

    <h2>Importar Arquivos</h2>
    <div class="flex">
        <div>
            <label>Selecione os Arquivos Excel:</label>
            <input type="file" id="fileInput" multiple>
        </div>
        <div>
            <button class="button import" id="loadExcelBtn">Importar</button>
        </div>
    </div>

</div>

<div class="panel">
    <h2>Opera√ß√µes Lan√ßadas</h2>
    <table id="tabela">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Banco</th>
                <th>Cedente</th>
                <th>Cession√°rio</th>
                <th>Compromissada</th>
                <th>Retorno</th>
                <th>PU Ida</th>
                <th>PU Volta</th>
                <th>Taxa CDI</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button class="button calc" onclick="calculateAndRender()">Calcular</button>
    <button class="button export" id="exportBtn">Exportar Excel</button>
    <button class="button clear" onclick="clearAll()">Limpar Tudo</button>
</div>

<div class="panel">
    <h2>Log do Sistema</h2>
    <div class="log" id="logBox"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

let operacoes = [];

function log(msg) {
    const logBox = document.getElementById("logBox");
    logBox.innerHTML += msg + "<br>";
    logBox.scrollTop = logBox.scrollHeight;
}

function parseNumber(value) {
    if (!value) return 0;
    let v = String(value).replace(/\./g, '').replace(',', '.');
    return parseFloat(v) || 0;
}

function cleanCdiTaxa(taxa) {
    if (!taxa) return "";
    return String(taxa).replace('%','').trim();
}

function formatDataBR(dataISO) {
    if (!dataISO) return '';
    const [y,m,d] = dataISO.split('-');
    return `${d}/${m}/${y}`;
}

function calculateAndRender() {
    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";

    operacoes.forEach(op => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${formatDataBR(op.data)}</td>
            <td>${op.descricao}</td>
            <td>${op.banco}</td>
            <td>${op.contaCedente}</td>
            <td>${op.contaCessionario}</td>
            <td>${op.compromissada}</td>
            <td>${op.retorno}</td>
            <td>${op.puIda}</td>
            <td>${op.puVolta}</td>
            <td>${op.cdiTaxa}</td>
        `;

        tbody.appendChild(tr);
    });

    log("üîÑ Tabela atualizada.");
}

function clearAll() {
    if (!confirm("Tem certeza que deseja limpar tudo?")) return;
    operacoes = [];
    calculateAndRender();
    log("üßπ Todos os dados foram apagados.");
}

async function loadExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = evt => {
            const data = new Uint8Array(evt.target.result);
            try {
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                resolve(json);
            } catch (e) {
                reject(e);
            }
        };

        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function processExcel(data) {

    if (!data || data.length < 2) {
        log("‚ö† Planilha vazia ou formato inv√°lido.");
        return [];
    }

    const header = data[0];

    const indices = {
        DATA: header.indexOf("Data"),
        DESCRICAO: header.indexOf("Descricao"),
        BANCO: header.indexOf("Banco"),
        CEDENTE: header.indexOf("Conta Cedente"),
        CESSIONARIO: header.indexOf("Conta Cessionario"),
        COMP: header.indexOf("Compromissada"),
        RET: header.indexOf("Retorno Bruto"),
        TAXA: header.indexOf("Taxa CDI Anual (%)"),
        PU_IDA: header.indexOf("PU Ida"),
        PU_VOLTA: header.indexOf("PU Volta")
    };

    let newOps = [];
    let valid = 0;

    for (let i = 1; i < data.length; i++) {
        const row = data[i];

        if (!row[indices.DATA]) continue;

        const excelDate = row[indices.DATA];
        let jsDate;

        if (typeof excelDate === "number") {
            jsDate = new Date((excelDate - 25569) * 86400 * 1000);
        } else {
            jsDate = new Date(excelDate);
        }

        const dataFormatada = jsDate.toISOString().slice(0, 10);

        const rawComp = row[indices.COMP];
        const rawRet = row[indices.RET];

        newOps.push({
            data: dataFormatada,
            descricao: String(row[indices.DESCRICAO] || ''),
            banco: String(row[indices.BANCO] || ''),
            contaCedente: String(row[indices.CEDENTE] || ''),
            contaCessionario: String(row[indices.CESSIONARIO] || ''),
            compromissada: String(rawComp || ''),
            retorno: String(rawRet || ''),
            cdiTaxa: String(row[indices.TAXA] || ''),
            puIda: String(row[indices.PU_IDA] || ''),
            puVolta: String(row[indices.PU_VOLTA] || '')
        });

        valid++;
    }

    log(`‚úÖ ${valid} opera√ß√µes v√°lidas encontradas.`);
    return newOps;
}

document.getElementById("loadExcelBtn").addEventListener("click", async () => {

    const fileInput = document.getElementById("fileInput");
    const files = fileInput.files;

    if (files.length === 0) {
        alert("Selecione um arquivo primeiro.");
        return;
    }

    log(`‚è≥ Processando ${files.length} arquivo(s)...`);

    let totalNewOps = [];

    for (const file of files) {
        try {
            const data = await loadExcel(file);
            const newOps = processExcel(data);
            totalNewOps = totalNewOps.concat(newOps);
            log(`üìÅ Arquivo "${file.name}" importado.`);
        } catch (e) {
            log(`‚ùå Erro ao processar "${file.name}".`);
            console.error(e);
        }
    }

    if (totalNewOps.length > 0) {
        operacoes = operacoes.concat(totalNewOps);
        calculateAndRender();
        log(`üéâ Importa√ß√£o conclu√≠da! ${totalNewOps.length} opera√ß√µes adicionadas.`);
    } else {
        log("‚ö† Nenhuma opera√ß√£o v√°lida encontrada.");
    }

    fileInput.value = "";

    /* CORRE√á√ÉO FEITA AQUI */
    loadExcelBtn.disabled = true;
});

document.getElementById("exportBtn").addEventListener("click", () => {

    if (operacoes.length === 0) {
        alert("N√£o h√° dados para exportar.");
        return;
    }

    const header = [
        "Data", "Descricao", "Banco", "Conta Cedente", "Conta Cessionario",
        "Compromissada", "Retorno Bruto", "PU Ida", "PU Volta", "Taxa CDI Anual (%)"
    ];

    const exportData = operacoes.map(op => {
        const taxa = cleanCdiTaxa(op.cdiTaxa);
        return [
            formatDataBR(op.data),
            op.descricao,
            op.banco,
            op.contaCedente,
            op.contaCessionario,
            parseNumber(op.compromissada),
            parseNumber(op.retorno),
            parseNumber(op.puIda),
            parseNumber(op.puVolta),
            taxa
        ];
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...exportData]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ganhos CDI");

    const hoje = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    XLSX.writeFile(wb, `Controle_Ganhos_CDI_${hoje}.xlsx`);

    log("üíæ Excel exportado.");
});

</script>
</body>
</html>
