<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        :root{
            /* CORES PRINCIPAIS: AZUL MARINHO ESCURO PRIM√ÅRIO, VERMELHO SECUND√ÅRIO */
            --primary: #0A0A33;  /* Azul Marinho Escuro */
            --primary-light: #1A1A55; /* Vers√£o mais clara para gradiente/hover */                        
            --secondary: #C00000; /* Vermelho Forte (Secund√°rio/Destaque) */
            --secondary-light: #E00000; /* Vermelho Claro para gradiente/hover */                        
            --danger: #c62828;  /* Mantido para a√ß√µes de exclus√£o */
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        /* Base */
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        /* Ajuste do Logo e T√≠tulo para ficarem √† esquerda e alinhados */
        #siteLogo{ 
            display:block; 
            max-width:140px; 
            width:100%; 
            height:auto; 
            border-radius:6px; 
            box-shadow:var(--shadow); 
            margin:0 0 6px 0;
        }
        #logo-wrapper{ margin-bottom:8px; }
        /* Header */
        #header-container{ 
            display:flex; 
            align-items:center; 
            gap:10px; 
            margin-bottom:8px; 
            width: fit-content; 
        }
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); } 
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        /* Cont√™iner para logo e t√≠tulo juntos */
        #left-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Top actions compacto */
        #top-actions{
            display:flex; align-items:center; gap:10px; padding:10px;
            background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border);
            flex-wrap:wrap;
        }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        /* --------------- BOT√ïES S√ìLIDOS COM CONTORNO BRANCO (ESTILO TRAVELEX) --------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            background: var(--primary);
            color: white; 
            border: 1px solid white; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); 
        }
        /* Estilo Secund√°rio (VERMELHO) */
        .btn.secondary {
            background: var(--secondary);
            color: white; 
            border: 1px solid white; 
        }
        .btn.small { 
            padding: 6px 10px; 
            font-size: 13px; 
            border-radius: 7px; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
            background: var(--primary-light); 
            border-color: white; 
        }
        .btn.secondary:hover {
            background: var(--secondary-light); 
            border-color: white;
            box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25);
        }
        .btn:active { 
            transform: none; 
            filter: brightness(0.96); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .btn.danger { 
            background: var(--secondary); 
            color: white; 
            border: 1px solid white; 
            box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25);
        }
        .btn.danger:hover { 
            filter: brightness(0.85); 
            border-color: white; 
        }
        /* ----------------------------------------------------------- */
        /* Layout empilhado: resultados em cima, painel embaixo */
        #main-container{
            display:flex;
            flex-direction:column;
            gap:14px;
            align-items:stretch;
        }
        /* Cards */
        .card{
            background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border);
            color:var(--text-dark);
        }
        /* Inputs */
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"]{
            padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px;
        }
        /* Totals */
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        /* Ganho total em verde */
        #totalCdiDisplay p { color: var(--success) !important; }
        /* Tabela */
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{
            position:sticky; top:0; z-index:2;
            background: linear-gradient(180deg,var(--primary-light),var(--primary));
            color:white; padding:10px 8px; text-align:left; font-weight:700;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        /* Descri√ß√£o/Resumo usa o novo primary (Azul Marinho) */
        .col-left{ 
            text-align:left; 
            max-width:260px; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            white-space:nowrap; 
            color: var(--primary); 
            font-weight: 600;
        }
        /* A√ß√µes compactas */
        .action-cell{ text-align:center; }
        /* --------------- GANHO/PERDA (BADGE) E NEGRITO GERAL --------------- */
        /* Estilo de Badge aplicado ao conte√∫do da TD */
        .ganho, .perda { 
            font-weight: 800; 
            padding: 2px 6px; 
            border-radius: 4px; 
            display: inline-block; 
            min-width: 60px; 
            text-align: center;
        }
        .ganho { 
            color: var(--success) !important;
            background: rgba(46, 125, 50, 0.1); 
            border: 1px solid rgba(46, 125, 50, 0.2);
        }
        .perda { 
            color: var(--danger) !important; 
            background: rgba(198, 40, 40, 0.1); 
            border: 1px solid rgba(198, 40, 40, 0.2);
        }
        /* Estilo para b/strong em geral */
        b, strong {
            font-weight: 800; 
            color: var(--primary); /* Negrito no Azul Marinho do tema */
        }
        /* ------------------------------------------------------------------- */
        /* Responsive */
        @media (max-width:980px){
            /* Centraliza em telas pequenas */
            #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; }
            #header-container{ margin-bottom:0; width: 100%; justify-content: center; }
            #left-header-content { justify-content: center; }
            .filter-card { margin-bottom: 12px !important; }
            .input-row{ flex-direction:column; align-items:stretch; }
        }
        /* Print */
        @media print{
            body{ background:white; padding:0; color:black; }
            #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn, #top-actions, #auth-status { display:none; }
        }
    </style>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.mini.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>

<body onload="loadState()">
     <div id="logo-wrapper">
        <img id="siteLogo" alt="Logo do site">
    </div>

    <div id="header-container">
        <div id="left-header-content">
            <div id="logo-placeholder">üìà</div>
            <h1>Controle de Ganhos CDI</h1>
        </div>
    </div>

    <div id="auth-status" class="card" style="padding: 10px; margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between;">
        <span id="login-message" style="font-weight: 600;">Status: Desconectado</span>
        <button id="loginBtn" class="btn small">Login (An√¥nimo)</button>
    </div>

    <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
        <div id="header-left">
            <div style="font-weight:700;">Resumo Di√°rio</div>
            <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
        </div>

        <div id="header-right">
            <button id="printBtn" class="btn small" title="Imprimir">Imprimir</button>
            <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>

            <label class="file-label" for="excelFile" title="Selecionar arquivos">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple>
                <span class="btn small">Procurar</span>
            </label>

            <button id="loadExcelBtn" class="btn small secondary" title="Importar arquivos">Importar</button>

            <label class="logo-label" for="logoFile" title="Carregar logo">
                <input type="file" id="logoFile" accept="image/*">
                <span class="btn small">Procurar</span>
            </label>

            <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo">Carregar Logo</button>
            <button id="removeLogoBtn" class="btn small" title="Remover">Remover</button>

            <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo">üóëÔ∏è</button>
        </div>
    </div>

    <div id="main-container">

        <div id="results-panel" class="card">
            <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>

            <div class="card filter-card" style="margin-bottom:10px;" aria-label="Op√ß√µes de Filtragem de Dados">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <div style="font-weight:600;color:var(--muted);">Filtros</div>
                    <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                </div>

                <div class="input-row" style="margin-top:8px;">
                    <div>
                        <label for="filterStartDate">Data de In√≠cio</label>
                        <input type="date" id="filterStartDate">
                    </div>

                    <div>
                        <label for="filterEndDate">Data de Fim</label>
                        <input type="date" id="filterEndDate">
                    </div>

                    <div style="display:flex;align-items:flex-end;gap:8px;">
                        <button id="filterBtn" class="btn small">Filtrar</button>
                        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-weight:600;color:var(--muted)">
                        <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                    </label>
                </div>
            </div>
            <div class="totals">
                <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
            </div>

            <div class="table-wrap">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th class="col-left">Descri√ß√£o/Resumo</th>
                            <th>Banco</th>
                            <th>Conta Cedente</th>
                            <th>Conta Cession√°rio</th>
                            <th>Compromissada</th>
                            <th>Retorno Bruto</th>
                            <th>PU Ida</th>
                            <th>PU Volta</th>
                            <th>Taxa CDI Anual (%)</th>
                            <th>Ganho (R$) Di√°rio</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>

            <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada. O sinal √© invertido automaticamente para opera√ß√µes de **RECOMPRA**.
            </p>
        </div>

        <div id="input-panel" class="card">
            <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>

            <div class="input-row">
                <div>
                    <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                    <input type="text" id="taxaCdiAnual" value="14,90" onchange="calculateAndRender()">
                </div>

                <div>
                    <label for="diasAno">Dias no Ano</label>
                    <input type="text" id="diasAno" value="252" onchange="calculateAndRender()">
                </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">

            <h3>üìÇ Importa√ß√£o</h3>
            <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                *O sistema prioriza as colunas **VL IDA** e **VL VOLTA** para os valores totais. **CONTRAPARTE** √© mapeado como Conta Cedente.
            </p>

            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">

            <h3>‚ûï Lan√ßamento Manual</h3>

            <div style="display:flex;flex-direction:column;gap:8px;">
                <input type="hidden" id="editIndex" value="-1">

                <div>
                    <label for="manualData">Data do Lan√ßamento</label>
                    <input type="date" id="manualData">
                </div>

                <div>
                    <label for="manualDesc">Descri√ß√£o</label>
                    <input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s">
                </div>

                <div>
                    <label for="manualBanco">Banco / Contraparte</label>
                    <input type="text" id="manualBanco" placeholder="Ex: BTG Pactual">
                </div>

                <div style="display:flex;gap:8px;">
                    <div style="flex:1;">
                        <label for="manualCedente">Conta Cedente</label>
                        <input type="text" id="manualCedente">
                    </div>
                    <div style="flex:1;">
                        <label for="manualCessionario">Conta Cession√°rio</label>
                        <input type="text" id="manualCessionario">
                    </div>
                </div>

                <div>
                    <label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label>
                    <input type="text" id="manualCdiTaxa">
                </div>

                <div style="display:flex;gap:8px;">
                    <div style="flex:1;">
                        <label for="manualCompromissada">Valor Compromissada</label>
                        <input type="text" id="manualCompromissada">
                    </div>
                    <div style="flex:1;">
                        <label for="manualRetorno">Valor Retorno (Bruto)</label>
                        <input type="text" id="manualRetorno">
                    </div>
                </div>

                <div style="display:flex;gap:8px;">
                    <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
                    <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
                </div>
            </div>
            <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
        </div>
    </div>

    <script>
        /* ============================================================
           CONFIGURA√á√ÉO DO FIREBASE
        ============================================================ */
        const firebaseConfig = {
            // Configura√ß√µes gen√©ricas de Firebase
            apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
            authDomain: "controle-cdi.firebaseapp.com",
            databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
            projectId: "controle-cdi",
            storageBucket: "controle-cdi.firebasestorage.app",
            messagingSenderId: "215359645646",
            appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
            measurementId: "G-TV1M1QWQRC"
        };

        let database = null;
        let currentUserUid = null;
        const DB_ROOT_PATH = "usuarios/";

        firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        /* ============================================================
           LOGIN / LOGOUT
        ============================================================ */
        const loginBtn = document.getElementById("loginBtn");
        const loginMessage = document.getElementById("login-message");
        const log = (message) => { document.getElementById('log').textContent = message; };

        loginBtn.addEventListener("click", () => {
            if (currentUserUid) {
                firebase.auth().signOut();
                return;
            }
            firebase.auth().signInAnonymously();
        });

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUserUid = user.uid;
                loginMessage.textContent = `Status: Conectado (UID: ${user.uid.substring(0, 8)}...)`;
                loginBtn.textContent = "Logout";
                loadStateFromFirebase();
            } else {
                currentUserUid = null;
                loginMessage.textContent = "Status: Desconectado";
                loginBtn.textContent = "Login (An√¥nimo)";
                operacoes = [];
                calculateAndRender();
            }
        });

        /* ============================================================
           FUN√á√ïES DE FORMATA√á√ÉO E UTILIDADE (ADOTANDO SUA L√ìGICA LOCAL)
        ============================================================ */
        
        function cleanCurrency(v){
            if(typeof v!=='string') v=String(v);
            let cleanString = v.replace(/[R$\s]/g, '');
            cleanString = cleanString.replace(/\./g, '');
            cleanString = cleanString.replace(/,/g, '.');
            const n=parseFloat(cleanString);
            return isNaN(n)?0:n;
        }

        function parseNumber(v){
            if(v===undefined||v===null||v==='') return 0;
            if(typeof v==='string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v);
            const n=parseFloat(v);
            return isNaN(n)?0:n;
        }

        function cleanCdiTaxa(v){
            if(!v) return 0;
            v=String(v).replace(/[^0-9,.]/g,'').replace(/,/g,'.');
            const parts=v.split('.');
            if(parts.length>2) v=parts.slice(0,-1).join('')+'.'+parts.slice(-1);
            let n=parseFloat(v);
            return isNaN(n)?0:n;
        }
        function formatBRL(n){ return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
        function formatPercent(n){ return (n||0).toFixed(4).replace('.',','); }
        function formatPU(n){ return n? n.toLocaleString("pt-BR",{minimumFractionDigits:4,maximumFractionDigits:4}) : "-"; }
        function formatDataBR(s){
            if(!s) return "-";
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)){
                const [y,m,d]=s.split("-");
                return `${d}/${m}/${y}`;
            }
            return s;
        }
        
        function normalizeDate(s){
            if(!s) return '';
            s=String(s).trim();
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
            if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
                const [d,m,y]=s.split('/');
                return `${y}-${m}-${d}`;
            }
            const num=parseFloat(s);
            if(!isNaN(num) && num>25569 && num<70000){ // Excel serial date
               const base=new Date('1899-12-30'); 
                const date=new Date(base.getTime() + num*24*60*60*1000);
                if(!isNaN(date)){
                    const y=date.getUTCFullYear();
                    const m=date.getUTCMonth()+1;
                    const d=date.getUTCDate();
                    const pad=n=>n<10?'0'+n:n;
                    return `${y}-${pad(m)}-${pad(d)}`;
                }
            }
            try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){}
            return '';
        }

        function normalizeHeader(str){
            return String(str || "")
                .toUpperCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // remove acentos
                .replace(/[^A-Z0-9]/g, "") // remove TUDO que n√£o for letra ou n√∫mero (incluindo . / - espa√ßos)
                .trim();
        }

        /* ============================================================
           ESTADO PRINCIPAL
        ============================================================ */
        let operacoes = [];
        let totalCompromissada = 0;
        let totalRetorno = 0;
        let totalGanho = 0;

        /* ============================================================
           SALVAR E CARREGAR DO FIREBASE
        ============================================================ */
        function saveState(){
            if(!currentUserUid) {
                log("‚ö†Ô∏è Desconectado. N√£o √© poss√≠vel salvar no Firebase.");
                return;
            }

            const state = {
                operacoes,
                taxaCdiAnual: document.getElementById("taxaCdiAnual").value,
                diasAno: document.getElementById("diasAno").value
            };

            database.ref(DB_ROOT_PATH + currentUserUid + "/operacoes").set(state)
                .then(() => log("üíæ Dados salvos no Firebase."))
                .catch(e => log("‚ùå Erro ao salvar no Firebase: " + e.message));
        }
        function loadStateFromFirebase(){
            if(!currentUserUid) return;

            database.ref(DB_ROOT_PATH + currentUserUid + "/operacoes").once("value")
            .then(snapshot=>{
                const data=snapshot.val();
                if(data){
                    operacoes = data.operacoes || [];
                    document.getElementById("taxaCdiAnual").value = data.taxaCdiAnual || "14,90";
                    document.getElementById("diasAno").value = data.diasAno || "252";
                    log(`üíæ ${operacoes.length} opera√ß√µes carregadas do Firebase.`);
                } else {
                    log('Aguardando... N√£o h√° dados salvos no Firebase.');
                }
                calculateAndRender();
            })
            .catch(e => log("‚ùå Erro ao carregar do Firebase: " + e.message));
        }

        /* ============================================================
           RENDERIZA√á√ÉO DA TABELA
        ============================================================ */
        function calculateAndRender(){
            const taxaGlobal = cleanCdiTaxa(document.getElementById("taxaCdiAnual").value)/100;
            const showOps = document.getElementById("showIndividualOps").checked;

            totalCompromissada=0;
            totalRetorno=0;
            totalGanho=0;

            const tbody=document.getElementById("resultBody");
            tbody.innerHTML="";

            const filterStartDateStr = document.getElementById('filterStartDate').value;
            const filterEndDateStr = document.getElementById('filterEndDate').value;
            const filterStart = filterStartDateStr ? normalizeDate(filterStartDateStr) : '';
            const filterEnd = filterEndDateStr ? normalizeDate(filterEndDateStr) : '';

            let lista = operacoes.filter(op=>{
                const d = normalizeDate(op.data);
                if(!d) return false;
                if(filterStart && d < filterStart) return false;
                if(filterEnd && d > filterEnd) return false;
                return true;
            });

            lista.sort((a,b)=> normalizeDate(a.data).localeCompare(normalizeDate(b.data)));
            
            const resumo = {};

            lista.forEach((op,i)=>{
                const d = normalizeDate(op.data);
                const compromissada = parseNumber(op.compromissada);
                const retorno = parseNumber(op.retornoBruto);
                const taxa = cleanCdiTaxa(op.cdiTaxa||taxaGlobal*100); 

                const puIda = parseNumber(op.puIda);
                const puVolta = parseNumber(op.puVolta);

                let ganho = retorno - compromissada;
                if(op.desc && op.desc.toUpperCase().includes("RECOMPRA")){
                    ganho = -ganho;
                }
                
                totalCompromissada+=compromissada;
                totalRetorno+=retorno;
                totalGanho+=ganho;

                if(!resumo[d]) resumo[d] = { data:d, totalCompromissada:0, totalRetorno:0, totalGanho:0, primeiraTaxa: taxa };
                resumo[d].totalCompromissada += compromissada;
                resumo[d].totalRetorno += retorno;
                resumo[d].totalGanho += ganho;
                

                if(showOps){
                    const tr=document.createElement("tr");
                    const ganhoClass = ganho>=0?'ganho':'perda';

                    tr.innerHTML=`
                        <td>${formatDataBR(op.data)}</td>
                        <td class="col-left">${op.desc || '-'}</td>
                        <td style="text-align:left;">${op.banco || '-'}</td>
                        <td>${op.cedente || '-'}</td>
                        <td>${op.cessionario || '-'}</td>
                        <td>${formatBRL(compromissada)}</td>
                        <td>${formatBRL(retorno)}</td>
                        <td>${formatPU(puIda)}</td>
                        <td>${formatPU(puVolta)}</td>
                        <td>${formatPercent(taxa)}</td>
                        <td><span class="${ganhoClass}">${formatBRL(ganho)}</span></td>
                        <td class="action-cell">
                            <button class="btn small" onclick="editOperation(${operacoes.indexOf(op)})">Alterar</button>
                            <button class="btn small danger" onclick="deleteOperation(${operacoes.indexOf(op)})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            // Adiciona Linhas de Resumo Di√°rio
            const datas = Object.keys(resumo).sort();
            if(showOps && datas.length) {
                const trHeader=document.createElement("tr");
                trHeader.innerHTML=`<td colspan="12" style="text-align:left;background:var(--primary);color:white;font-weight:700;">RESUMO DI√ÅRIO (Consolida√ß√£o por dia)</td>`;
                tbody.appendChild(trHeader);
            }

            datas.forEach(k=>{
                const r = resumo[k];
                const ganhoClass = r.totalGanho>=0?'ganho':'perda';
                const tr=document.createElement("tr");
                
                tr.innerHTML=`
                    <td class="col-data">${formatDataBR(r.data)}</td>
                    <td class="col-left">Soma Di√°ria</td>
                    <td class="col-left">-</td><td>-</td><td>-</td>
                    <td>${formatBRL(r.totalCompromissada)}</td>
                    <td>${formatBRL(r.totalRetorno)}</td>
                    <td>-</td><td>-</td><td style="text-align:center;">${formatPercent(r.primeiraTaxa)}</td>
                    <td class="${ganhoClass}">${formatBRL(r.totalGanho)}</td>
                    <td class="action-cell">-</td>
                `;
                tr.style.fontWeight = '700';
                tr.style.background = 'rgba(10, 10, 51, 0.05)'; 
                tbody.appendChild(tr);
            });


            document.querySelector("#totalCompromissadaDisplay p").textContent = formatBRL(totalCompromissada);
            document.querySelector("#totalRetornoDisplay p").textContent = formatBRL(totalRetorno);
            document.querySelector("#totalCdiDisplay p").textContent = formatBRL(totalGanho);

            if(!showOps && !datas.length){
                const tr=document.createElement("tr");
                const td=document.createElement("td");
                td.colSpan=12;
                td.style.textAlign="center";
                td.style.color="var(--muted)";
                td.textContent="Nenhuma opera√ß√£o encontrada no filtro.";
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }

        /* ============================================================
           FILTROS
        ============================================================ */
        document.getElementById("filterBtn").addEventListener("click",()=>{
            calculateAndRender();
        });
        document.getElementById("resetFilterBtn").addEventListener("click",()=>{
            document.getElementById("filterStartDate").value="";
            document.getElementById("filterEndDate").value="";
            calculateAndRender();
        });

        /* ============================================================
           EXCLUS√ÉO
        ============================================================ */
        function deleteOperation(i){
            if(!confirm("Excluir esta opera√ß√£o?")) return;
            operacoes.splice(i,1);
            saveState();
            calculateAndRender();
        }

        document.getElementById("deleteAllBtn").addEventListener("click", () => {
            if (!confirm("Tem certeza que deseja EXCLUIR TODAS as opera√ß√µes? Esta a√ß√£o n√£o pode ser desfeita e ser√° aplicada no Firebase.")) {
                return;
            }
            operacoes = [];
            saveState();
            calculateAndRender();
            alert("Todas as opera√ß√µes foram exclu√≠das.");
        });

        /* ============================================================
           LAN√áAMENTO MANUAL / EDI√á√ÉO
        ============================================================ */
        const addBtn = document.getElementById("addBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const editIndex = document.getElementById("editIndex");

        function resetManualForm() {
            document.getElementById("manualData").value = "";
            document.getElementById("manualDesc").value = "";
            document.getElementById("manualBanco").value = "";
            document.getElementById("manualCedente").value = "";
            document.getElementById("manualCessionario").value = "";
            document.getElementById("manualCdiTaxa").value = "";
            document.getElementById("manualCompromissada").value = "";
            document.getElementById("manualRetorno").value = "";

            editIndex.value = "-1";
            addBtn.textContent = "Adicionar Lan√ßamento";
            cancelEditBtn.style.display = "none";
        }

        addBtn.addEventListener("click", () => {
            const data = document.getElementById("manualData").value;
            const desc = document.getElementById("manualDesc").value;
            const banco = document.getElementById("manualBanco").value;
            const cedente = document.getElementById("manualCedente").value;
            const cessionario = document.getElementById("manualCessionario").value;
            const cdiTaxa = document.getElementById("manualCdiTaxa").value;
            const compromissada = document.getElementById("manualCompromissada").value;
            const retorno = document.getElementById("manualRetorno").value;

            if (!data || !desc || !compromissada || !retorno) {
                alert("Preencha Data, Descri√ß√£o, Valor Compromissada e Valor Retorno.");
                return;
            }

            const newOp = {
                data: normalizeDate(data),
                desc: desc,
                banco: banco,
                cedente: cedente,
                cessionario: cessionario,
                compromissada: cleanCurrency(compromissada), 
                retornoBruto: cleanCurrency(retorno), 
                cdiTaxa: cdiTaxa
            };

            const index = parseInt(editIndex.value);
            if (index >= 0) {
                operacoes[index] = newOp;
                log("Opera√ß√£o alterada com sucesso!");
            } else {
                operacoes.push(newOp);
                log("Opera√ß√£o adicionada com sucesso!");
            }

            saveState();
            calculateAndRender();
            resetManualForm();
        });

        cancelEditBtn.addEventListener("click", resetManualForm);

        window.editOperation = function(i) {
            const op = operacoes[i];

            document.getElementById("manualData").value = normalizeDate(op.data);
            document.getElementById("manualDesc").value = op.desc;
            document.getElementById("manualBanco").value = op.banco || '';
            document.getElementById("manualCedente").value = op.cedente;
            document.getElementById("manualCessionario").value = op.cessionario;
            document.getElementById("manualCdiTaxa").value = op.cdiTaxa || "";
            
            document.getElementById("manualCompromissada").value = (op.compromissada || 0).toLocaleString('pt-BR');
            document.getElementById("manualRetorno").value = (op.retornoBruto || 0).toLocaleString('pt-BR');
            
            editIndex.value = i;
            addBtn.textContent = "Salvar Altera√ß√£o";
            cancelEditBtn.style.display = "inline-flex";

            document.getElementById("input-panel").scrollIntoView({ behavior: "smooth" });
        }
        
        /* ============================================================
           IMPORTA√á√ÉO EXCEL (SheetJS) - VERS√ÉO CORRIGIDA PARA VALORES E CONTAS
        ============================================================ */

        document.getElementById("loadExcelBtn").addEventListener("click",()=>{
            const files = document.getElementById("excelFile").files;
            if(files.length === 0){
                alert("Selecione um arquivo primeiro.");
                return;
            }
            const file = files[0];
            
            const reader=new FileReader();
            reader.onload=e=>{
                processExcelData(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        });

        function processExcelData(data){
            const workbook = XLSX.read(data,{type:"array"});
            const sheet = workbook.Sheets[workbook.Sheets[0] || workbook.SheetNames[0]]; 

            // L√™ a planilha em formato de array de arrays, sem formatar os dados
            const json = XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});


            if(json.length < 2){
                alert("Arquivo vazio ou com apenas o cabe√ßalho.");
                return;
            }

            const headers = json[0].map(h => normalizeHeader(h));
            
            const map={};

            // Mapeamento CORRIGIDO:
            const known = {
               const known = {
          // DATA
          "DTINICIO": "data",
          "DATAINICIO": "data",
          "DATA": "data",

         // VENCIMENTO (opcional)
        "DTVENCTO": "dataVencimento",
        "DATAVENCTO": "dataVencimento",

        // PU / QTD
       "PUIDA": "puIda",
       "PUVOLTA": "puVolta",
      "QUANTIDADE": "quantidade",

       // TAXA
      "TX252": "cdiTaxa",
      "TAXACDI": "cdiTaxa",

      // DESCRI√á√ÉO
      "TIPOOPERACAO": "desc",
      "OPERACAO": "desc",
      "PAPEL": "desc2",

      // CONTAS / BANCO
      "VEICULOLEGAL": "banco",
      "BANCO": "banco",
      "CONTRAPARTE": "cedente",
      "CONTA CEDENTE": "cedente",
      "CONTA CESSIONARIO": "cessionario",

      // VALORES
      "VLIDA": "compromissada",
      "VL VOLTA": "retornoBruto",
      "VLVOLTA": "retornoBruto"
  };


            headers.forEach((h,i)=>{
                if(known[h]) map[known[h]]=i;
            });

            if (!map.data) {
                 alert("N√£o foi poss√≠vel mapear a coluna obrigat√≥ria: Data de In√≠cio (DT.IN√çCIO). Verifique o cabe√ßalho do arquivo.");
                return;
            }

            const hasDirectValueFields = map.compromissada !== undefined && map.retornoBruto !== undefined;
            const hasPUCalculationFields = map.puIda !== undefined && map.puVolta !== undefined && map.quantidade !== undefined;

            if (!hasDirectValueFields && !hasPUCalculationFields) {
                alert("N√£o foi poss√≠vel mapear as colunas de valor (VL IDA e VL VOLTA) ou (PU IDA, PU VOLTA e QUANTIDADE).");
                return;
            }

            const novos=[];
            for(let i=1;i<json.length;i++){
                const row=json[i];
                
                if(!row || !row[map.data]) continue;

                let rawDate = normalizeDate(row[map.data]);
                if(!rawDate) continue; 
                
                let compromissada = 0;
                let retornoBruto = 0;
                let qtd = 1;
                let puIda = 0;
                let puVolta = 0;

                // --- L√ìGICA DE LEITURA E C√ÅLCULO ---
                
                // 1. Tenta ler PU e QTD para fins de registro
                puIda = map.puIda !== undefined ? parseNumber(row[map.puIda]) : 0;
                puVolta = map.puVolta !== undefined ? parseNumber(row[map.puVolta]) : 0;
                qtd = map.quantidade !== undefined ? parseNumber(row[map.quantidade]) : 1;

                if (hasDirectValueFields) {
                    // Prioridade 1: Leitura de Valor Total (VL IDA / VL VOLTA)
                    // Usamos a fun√ß√£o parseNumber que lida com diferentes formatos (R$ / , / .)
                    compromissada = parseNumber(row[map.compromissada]);
                    retornoBruto = parseNumber(row[map.retornoBruto]);
                    
                } else if (hasPUCalculationFields) {
                    // Prioridade 2: C√°lculo PU * QTD (Caso n√£o haja VL IDA/VOLTA)
                    if(puIda === 0 || puVolta === 0 || qtd === 0) continue;
                    compromissada = puIda * qtd; 
                    retornoBruto = puVolta * qtd;
                } else {
                    continue;
                }

                if (compromissada === 0 && retornoBruto === 0) continue;

                const finalDesc = (row[map.desc] || row[map.desc2] || "Opera√ß√£o").trim();

                novos.push({
                    data: rawDate, 
                    dataVencimento: map.dataVencimento ? normalizeDate(row[map.dataVencimento]) : "",
                    desc: finalDesc,
                    banco: row[map.banco] || "",
                    cedente: row[map.cedente] || "", 
                    cessionario: "", 
                    quantidade: qtd,
                    puIda: puIda,
                    puVolta: puVolta,
                    cdiTaxa: cleanCdiTaxa(row[map.cdiTaxa] || ""),
                    
                    compromissada: compromissada,
                    retornoBruto: retornoBruto
                });
            }
            
            operacoes = operacoes.concat(novos);
            saveState();
            calculateAndRender();
            alert(`${novos.length} opera√ß√µes importadas com sucesso!`);
        }

        /* ============================================================
           FUN√á√ÉO DE EXPORTA√á√ÉO
        ============================================================ */
        function exportData() {
            if (operacoes.length === 0) {
                alert("N√£o h√° dados para exportar.");
                return;
            }

            const taxaGlobal = cleanCdiTaxa(document.getElementById("taxaCdiAnual").value);
            
            const dadosExportacao = operacoes.map((op) => {
                const compromissada = parseNumber(op.compromissada);
                const retorno = parseNumber(op.retornoBruto);
                const taxa = cleanCdiTaxa(op.cdiTaxa || taxaGlobal);
                let ganho = retorno - compromissada;
                
                if (op.desc && op.desc.toUpperCase().includes("RECOMPRA")) {
                    ganho = -ganho;
                }

                return {
                    "Data": formatDataBR(op.data),
                    "Descri√ß√£o": op.desc || "",
                    "Banco": op.banco || "",
                    "Conta Cedente": op.cedente || "",
                    "Conta Cession√°rio": op.cessionario || "",
                    "Compromissada": compromissada,
                    "Retorno Bruto": retorno,
                    "Taxa CDI (%)": taxa,
                    "Ganho (R$)": ganho
                };
            });

            const ws = XLSX.utils.json_to_sheet(dadosExportacao);
            
            const colIndexMap = {
                "Compromissada": 'F', 
                "Retorno Bruto": 'G', 
                "Taxa CDI (%)": 'H', 
                "Ganho (R$)": 'I'
            };
            
            for (let R = 1; R <= dadosExportacao.length; ++R) {
                const rowKey = R + 1;

                if (ws[colIndexMap["Compromissada"] + rowKey]) {
                    ws[colIndexMap["Compromissada"] + rowKey].z = 'R$ #,##0.00';
                }
                if (ws[colIndexMap["Retorno Bruto"] + rowKey]) {
                    ws[colIndexMap["Retorno Bruto"] + rowKey].z = 'R$ #,##0.00';
                }
                if (ws[colIndexMap["Ganho (R$)"] + rowKey]) {
                    ws[colIndexMap["Ganho (R$)"] + rowKey].z = 'R$ #,##0.00';
                }
                
                if (ws[colIndexMap["Taxa CDI (%)"] + rowKey]) {
                    ws[colIndexMap["Taxa CDI (%)"] + rowKey].z = '0.0000%';
                    ws[colIndexMap["Taxa CDI (%)"] + rowKey].v = ws[colIndexMap["Taxa CDI (%)"] + rowKey].v / 100; 
                }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OperacoesCDI");

            const filename = `ControleCDI_Exportacao_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        /* ============================================================
           CARREGAMENTO INICIAL E LOGO
        ============================================================ */
        window.loadState = function(){
            calculateAndRender();
            
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            
            document.getElementById('exportBtn').addEventListener('click', exportData);
            
            // L√≥gica simples de logo (sem persist√™ncia no Firebase)
            const siteLogo = document.getElementById('siteLogo');
            const logoInput = document.getElementById('logoFile');
            
            // Carrega logo salvo localmente (se houver)
            const savedLogo = localStorage.getItem('cdiLogo');
            if (savedLogo) {
                siteLogo.src = savedLogo;
                siteLogo.style.display = 'block';
            } else {
                siteLogo.style.display = 'none';
            }

            // A√ß√£o de Carregar Logo
            document.getElementById('addLogoBtn').addEventListener('click', () => {
                logoInput.click();
            });
            
            logoInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        siteLogo.src = e.target.result;
                        siteLogo.style.display = 'block';
                        localStorage.setItem('cdiLogo', e.target.result);
                        log('‚úÖ Logo salvo localmente.');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // A√ß√£o de Remover Logo
            document.getElementById('removeLogoBtn').addEventListener('click', () => {
                if(!confirm('Tem certeza que deseja remover logo salvo?')) return;
                localStorage.removeItem('cdiLogo');
                siteLogo.src = '';
                siteLogo.style.display = 'none';
                log('üóëÔ∏è Logo removido.');
            });
        };
    </script>
</body>
</html>
