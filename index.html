<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        /* ... SEU C√ìDIGO CSS (STYLE) ORIGINAL PERMANECE AQUI INTACTO ... */
        :root{
            /* CORES PRINCIPAIS: AZUL MARINHO ESCURO PRIM√ÅRIO, VERMELHO SECUND√ÅRIO */
            --primary: #0A0A33;  /* Azul Marinho Escuro */
            --primary-light: #1A1A55; /* Vers√£o mais clara para gradiente/hover */
            --secondary: #C00000; /* Vermelho Forte (Secund√°rio/Destaque) */
            --secondary-light: #E00000; /* Vermelho Claro para gradiente/hover */
            --danger: #c62828;  /* Mantido para a√ß√µes de exclus√£o */
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        /* Base */
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        /* Ajuste do Logo e T√≠tulo para ficarem √† esquerda e alinhados */
        #siteLogo{
            display:block; /* Muda para block */
            max-width:140px;
            width:100%;
            height:auto;
            border-radius:6px;
            box-shadow:var(--shadow);
            margin:0 0 6px 0; /* Remove margem autom√°tica, alinha √† esquerda */
        }
        #logo-wrapper{ /* Este se torna desnecess√°rio, mas o mantive no HTML abaixo para o logo */
            margin-bottom:8px;
        }
        /* Header */
        #header-container{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:8px;
            /* Para manter o cont√™iner √† esquerda se o logo estiver no topo */
            width: fit-content;
        }
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); }
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        /* Cont√™iner para logo e t√≠tulo juntos */
        #left-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Top actions compacto */
        #top-actions{
            display:flex; align-items:center; gap:10px; padding:10px;
            background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border);
            flex-wrap:wrap;
        }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        /* --------------- BOT√ïES S√ìLIDOS COM CONTORNO BRANCO (ESTILO TRAVELEX) --------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            /* Estilo Padr√£o (AZUL MARINHO): Fundo Primary, Texto Branco, Borda Branca */
            background: var(--primary); /* Fundo Azul Marinho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Sombra padr√£o */
        }
        /* Estilo Secund√°rio (VERMELHO): Fundo Secondary, Texto Branco, Borda Branca */
        .btn.secondary {
            background: var(--secondary); /* Fundo Vermelho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
        }
        .btn.small {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 7px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            background: var(--primary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
        }
        .btn.secondary:hover {
            background: var(--secondary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
            box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25);
        }
        .btn:active {
            transform: none;
            filter: brightness(0.96);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        /* O bot√£o danger √© usado no delete, mas como voc√™ quer ele VERMELHO (secondary),
            ele usar√° o estilo .btn.secondary, com uma pequena varia√ß√£o de cor */
        .btn.danger {
            background: var(--secondary);
            color: white;
            border: 1px solid white;
            box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25);
        }
        .btn.danger:hover {
            filter: brightness(0.85);
            border-color: white;
        }
        /* ----------------------------------------------------------- */
        /* Layout empilhado: resultados em cima, painel embaixo */
        #main-container{
            display:flex;
            flex-direction:column;
            gap:14px;
            align-items:stretch;
        }
        /* Cards */
        .card{
            background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border);
            color:var(--text-dark);
        }
        /* Inputs */
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"], input[type="email"], input[type="password"]{
            padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px;
        }
        /* Totals */
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        /* Ganho total em verde */
        #totalCdiDisplay p { color: var(--success) !important; }
        /* Tabela */
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{
            position:sticky; top:0; z-index:2;
            /* Tira grande agora √© Azul Marinho */
            background: linear-gradient(180deg,var(--primary-light),var(--primary));
            color:white; padding:10px 8px; text-align:left; font-weight:700;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        /* Descri√ß√£o/Resumo usa o novo primary (Azul Marinho) */
        .col-left{
            text-align:left;
            max-width:260px;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            color: var(--primary);
            font-weight: 600;
        }
        /* A√ß√µes compactas */
        .action-cell{ text-align:center; }
        /* --------------- GANHO/PERDA (BADGE) E NEGRITO GERAL --------------- */
        /* Estilo de Badge aplicado ao conte√∫do da TD */
        .ganho, .perda {
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        .ganho {
            color: var(--success) !important;
            background: rgba(46, 125, 50, 0.1);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }
        .perda {
            color: var(--danger) !important;
            background: rgba(198, 40, 40, 0.1);
            border: 1px solid rgba(198, 40, 40, 0.2);
        }
        /* Estilo para b/strong em geral */
        b, strong {
            font-weight: 800;
            color: var(--primary); /* Negrito no Azul Marinho do tema */
        }
        /* ------------------------------------------------------------------- */
        /* Responsive */
        @media (max-width:980px){
            /* Centraliza em telas pequenas */
            #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; }
            #header-container{ margin-bottom:0; width: 100%; justify-content: center; }
            #left-header-content { justify-content: center; }
            .input-row{ flex-direction:column; align-items:stretch; }
        }
        /* Print */
        @media print{
            body{ background:white; padding:0; color:black; }
            #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn { display:none; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="xlsx.mini.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body onload="loadState()">
    <div id="logo-wrapper">
        <img id="siteLogo" alt="Logo do site">
    </div>
    <div id="header-container">
        <div id="left-header-content">
            <div id="logo-placeholder">üìà</div>
            <h1>Controle de Ganhos CDI</h1>
        </div>
    </div>
        
    <div id="auth-status" class="card" style="padding: 10px; margin-bottom: 14px; display: flex; flex-direction: column; gap: 8px;">
        <div style="display:flex; flex-wrap: wrap; gap: 8px; align-items: center;">
            <input type="email" id="emailInput" placeholder="Seu E-mail" required style="padding: 6px; border-radius: 6px; border: 1px solid var(--card-border); flex-grow: 1; min-width: 150px;">
            <input type="password" id="passwordInput" placeholder="Sua Senha (m√≠n. 6)" required style="padding: 6px; border-radius: 6px; border: 1px solid var(--card-border); flex-grow: 1; min-width: 150px;">
            <button id="loginBtn" class="btn small" style="min-width: 120px; margin-left: auto;">Login / Logout</button>
        </div>
        <span id="login-message" style="font-weight: 600; font-size: 12px; color: var(--muted); align-self: flex-start;">Status: Desconectado. Fa√ßa login para acessar seus dados.</span>
    </div>
    <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
        <div id="header-left">
            <div style="font-weight:700;">Resumo Di√°rio</div>
            <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
        </div>
                
        <div id="header-right">
            <button id="printBtn" class="btn small" title="Imprimir">Imprimir</button>
            <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>
                        
            <label class="file-label" for="excelFile" title="Selecionar arquivos">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple>
                <span class="btn small">Procurar</span>
            </label>
            <button id="loadExcelBtn" class="btn small secondary" title="Importar arquivos">Importar</button>
            <label class="logo-label" for="logoFile" title="Carregar logo">
                <input type="file" id="logoFile" accept="image/*">
                <span class="btn small">Procurar</span>
            </label>
            <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo">Carregar Logo</button>
            <button id="removeLogoBtn" class="btn small" title="Remover">Remover</button>
            <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo">üóëÔ∏è</button>
        </div>
    </div>
    <div id="main-container">
        <div id="results-panel" class="card">
            <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>
            <div class="card filter-card" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <div style="font-weight:600;color:var(--muted);">Filtros</div>
                    <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                </div>
                <div class="input-row" style="margin-top:8px;">
                    <div>
                        <label for="filterStartDate">Data de In√≠cio</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div>
                        <label for="filterEndDate">Data de Fim</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;">
                        <button id="filterBtn" class="btn small">Filtrar</button>
                        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-weight:600;color:var(--muted)">
                        <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                    </label>
                </div>
            </div>
            <div class="totals">
                <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
            </div>
            <div class="table-wrap">
                <div id="resultTable"></div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
            </p>
        </div>
        <div id="input-panel" class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>
            </div>
            <div class="input-row">
                <div>
                    <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                    <input type="text" id="taxaCdiAnual" placeholder="14,90" value="14,90" onchange="calculateAndRender()">
                </div>
                <div>
                    <label for="diasAno">Dias no Ano</label>
                    <input type="text" id="diasAno" placeholder="252" value="252" onchange="calculateAndRender()">
                </div>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">üìÇ Importa√ß√£o</h3>
                <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                    *O sistema tenta reconhecer os cabe√ßalhos, priorizando 'TX. 252' para a taxa CDI.
                </p>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">‚ûï Lan√ßamento Manual</h3>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <input type="hidden" id="editIndex" value="-1">
                    <div><label for="manualData">Data do Lan√ßamento</label><br><input type="date" id="manualData" required></div>
                    <div><label for="manualDesc">Descri√ß√£o</label><br><input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s"></div>
                    <div><label for="manualBanco">Banco / Contraparte</label><br><input type="text" id="manualBanco" placeholder="Ex: BTG Pactual"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCedente">Conta Cedente</label><br><input type="text" id="manualCedente" placeholder="8300005"></div>
                        <div style="flex:1;"><label for="manualCessionario">Conta Cession√°rio</label><br><input type="text" id="manualCessionario" placeholder="12000005"></div>
                    </div>
                    <div><label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label><br><input type="text" id="manualCdiTaxa" placeholder="14,90 (Deixar vazio para usar Global)"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCompromissada">Valor Compromissada</label><br><input type="text" id="manualCompromissada" placeholder="10.000,00"></div>
                        <div style="flex:1;"><label for="manualRetorno">Valor Retorno (Bruto)</label><br><input type="text" id="manualRetorno" placeholder="10.050,25"></div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
                        <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
                    </div>
                </div>
            </div>
            <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
        </div>
    </div>
        
    <script>
        // ====================================================================
        // FIREBASE REALTIME DATABASE E AUTENTICA√á√ÉO
        // ====================================================================

        // Suas chaves de configura√ß√£o do Firebase (MANTIDAS AQUI)
        const firebaseConfig = {
            apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
            authDomain: "controle-cdi.firebaseapp.com",
            databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
            projectId: "controle-cdi",
            storageBucket: "controle-cdi.firebasestorage.app",
            messagingSenderId: "215359645646",
            appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
            measurementId: "G-TV1M1QWQRC"
        };

        let database = null;
        let currentUserUid = null; // Armazena o ID √∫nico do usu√°rio autenticado
        const DB_ROOT_PATH = 'usuarios/'; // Caminho seguro no Realtime Database

        // Inicializa o Firebase        
        if (typeof firebase !== 'undefined' && typeof firebase.database !== 'undefined' && typeof firebase.auth !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } else {
            console.error("Firebase SDKs n√£o carregados. O salvamento/autentica√ß√£o em nuvem n√£o funcionar√£o.");
        }

        // --- L√≥gica de Autentica√ß√£o (MODIFICADA PARA LOGIN/SENHA) ---

        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('login-message');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        
        // Tenta fazer login com E-mail/Senha (ou cadastra se n√£o existir)
        function handleLogin() {
            if (!firebase.auth()) {
                loginMessage.textContent = "Erro: Firebase Auth n√£o carregado.";
                return;
            }

            if (currentUserUid) {
                // Se j√° estiver logado, faz logout
                firebase.auth().signOut().then(() => {
                    log('Desconectado do Firebase.');
                    currentUserUid = null;
                    loginBtn.textContent = 'Login / Cadastrar';
                    loginMessage.textContent = 'Status: Desconectado. Fa√ßa login para acessar seus dados.';
                    operacoes = []; // Limpa os dados vis√≠veis
                    calculateAndRender();
                });
            } else {
                // Tenta Login/Cadastro com E-mail e Senha
                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password || password.length < 6) {
                    loginMessage.textContent = '‚ö†Ô∏è Informe E-mail e Senha (m√≠nimo 6 caracteres).';
                    return;
                }

                loginMessage.textContent = 'Tentando conectar...';
                
                // 1. Tenta fazer login
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        log('Login realizado com sucesso. Dados carregando...');
                        // Limpar campos ap√≥s login/cadastro bem-sucedido
                        emailInput.value = ''; 
                        passwordInput.value = '';
                        // O onAuthStateChanged far√° o resto
                    })
                    .catch((error) => {
                        // 2. Se o erro for 'usu√°rio n√£o encontrado', tenta cadastrar
                        if (error.code === 'auth/user-not-found') {
                            loginMessage.textContent = 'Usu√°rio n√£o cadastrado. Tentando cadastrar...';
                            firebase.auth().createUserWithEmailAndPassword(email, password)
                                .then(() => {
                                    log('‚úÖ Novo usu√°rio cadastrado e logado com sucesso!');
                                    emailInput.value = '';
                                    passwordInput.value = '';
                                    // O onAuthStateChanged far√° o resto
                                })
                                .catch((err) => {
                                    log(`‚ùå Erro ao Cadastrar: ${err.message}`);
                                    loginMessage.textContent = `Falha no Cadastro: ${err.message}. Verifique a senha (m√≠n. 6) ou o formato do e-mail.`;
                                });
                        } else {
                            // 3. Outros erros de login (senha incorreta, etc.)
                            log(`‚ùå Erro de Login: ${error.message}`);
                            loginMessage.textContent = `Falha no Login: ${error.message}`;
                        }
                    });
            }
        }

        // Listener para o estado da autentica√ß√£o (chamado no carregamento e em cada mudan√ßa de estado)        
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // Usu√°rio logado
                currentUserUid = user.uid;
                // Exibe o e-mail se existir, sen√£o usa o UID (fallback)
                loginMessage.textContent = `Status: Conectado (Usu√°rio: ${user.email || user.uid.substring(0, 8) + '...'})`;
                loginBtn.textContent = 'Logout';
                log('Conex√£o estabelecida e segura. Carregando seus dados...');
                loadStateFromFirebase(); // Chama o carregamento SEGURO
            } else {
                // Usu√°rio deslogado
                currentUserUid = null;
                loginBtn.textContent = 'Login / Cadastrar';
                loginMessage.textContent = 'Status: Desconectado. Fa√ßa login para acessar seus dados.';
                operacoes = [];
                calculateAndRender();
            }
        });

        if (loginBtn) {
            loginBtn.addEventListener('click', handleLogin);
        }

        // ====================================================================
        /* ---------- Fun√ß√µes utilit√°rias e l√≥gica ---------- */
        function log(message) { document.getElementById('log').textContent = message; }
        
        function resetThemeToFixed() {
            document.documentElement.style.setProperty('--primary', '#0A0A33');
            document.documentElement.style.setProperty('--primary-light', '#1A1A55');
            document.documentElement.style.setProperty('--secondary', '#C00000');
            document.documentElement.style.setProperty('--secondary-light', '#E00000');

            document.querySelectorAll('.btn:not(.secondary):not(.danger)').forEach(b => {
                b.style.background = 'var(--primary)';
                b.style.border = '1px solid white';
                b.style.color = 'white';
            });

            document.querySelectorAll('.btn.secondary').forEach(b => {
                b.style.background = 'var(--secondary)';
                b.style.border = '1px solid white';
                b.style.color = 'white';
            });

            document.querySelectorAll('.btn.danger').forEach(b=>{
                b.style.background = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                b.style.color = '#ffffff';
                b.style.border = '1px solid white';
            });
        }
        
        const logoInput = document.getElementById('logoFile');
        const siteLogo = document.getElementById('siteLogo');
        async function compressImageFile(file, quality = 0.7, maxSize = 600) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ratio = Math.min(1, maxSize / Math.max(img.width, img.height));
                        canvas.width = Math.round(img.width * ratio);
                        canvas.height = Math.round(img.height * ratio);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        try {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        } catch (err) { reject(err); }
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        if (logoInput) {
            logoInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if(!file) return;

                try {
                    const compressed = await compressImageFile(file, 0.7, 600);
                    siteLogo.src = compressed;
                    siteLogo.style.display = 'block';
                    localStorage.setItem('cdiLogo', compressed);
                    log('‚úÖ Logo salvo localmente.');
                } catch (err) {
                    console.error(err);
                    log('‚ùå Erro ao processar o logo.');
                }
                resetThemeToFixed();
            });

            const addLogoBtn = document.getElementById('addLogoBtn');
            if (addLogoBtn) {
                addLogoBtn.addEventListener('click', () => {
                    logoInput.click();
                });
            }
        }
        const removeLogoBtn = document.getElementById('removeLogoBtn');
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', ()=>{
                if(!confirm('Tem certeza que deseja remover logo salvo e restaurar padr√£o?')) return;
                localStorage.removeItem('cdiLogo');
                siteLogo.src = '';
                siteLogo.style.display = 'none';
                resetThemeToFixed();
                log('üóëÔ∏è Logo removido. Tema restaurado.');
            });
        }

        function cleanCurrency(v){ 
            if(typeof v!=='string') v=String(v); 
            let cleanString = v.replace(/[R$\s]/g, '');
            cleanString = cleanString.replace(/\./g, '');
            cleanString = cleanString.replace(/,/g, '.');
            const n=parseFloat(cleanString); 
            return isNaN(n)?0:n; 
        }

        function parseNumber(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v==='string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v); 
            const n=parseFloat(v); 
            return isNaN(n)?0:n; 
        }

        function cleanCdiTaxa(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v!=='string') v=String(v); 
            v=v.replace(/[^0-9,.]/g,''); 
            v = v.replace(/,/g,'.'); // Troca v√≠rgula por ponto universalmente
            // Remove pontos extras, deixando apenas o √∫ltimo (ou nenhum)
            const parts = v.split('.');
            if(parts.length > 2) {
                v = parts.slice(0, -1).join('') + '.' + parts.slice(-1);
            }
            const n=parseFloat(v); 
            return isNaN(n)?0:n; 
        }

        function formatBRL(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); }
        function formatPercent(n){ if(n===undefined||n===null||isNaN(n)) return ''; return n.toFixed(4).replace('.',','); }
        function formatPU(n){ if(n===undefined||n===null||isNaN(n)||n===0) return '-'; return n.toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }
        function formatDataBR(s){ if(!s) return '-'; if(s.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; } if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s; const d=new Date(s); if(!isNaN(d)) return d.toLocaleDateString('pt-BR'); return s; }

        function normalizeDate(s){ 
            if(!s) return ''; 
            s=String(s).trim(); 
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
            if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
                const [d,m,y]=s.split('/');
                return `${y}-${m}-${d}`; 
            }
            const num=parseFloat(s);
            if(!isNaN(num) && num>25569 && num<70000){ // Excel serial date
                const base=new Date('1899-12-30'); 
                const date=new Date(base.getTime() + num*24*60*60*1000); 
                if(!isNaN(date)){
                    const y=date.getUTCFullYear();
                    const m=date.getUTCMonth()+1;
                    const d=date.getUTCDate();
                    const pad=n=>n<10?'0'+n:n;
                    return `${y}-${pad(m)}-${pad(d)}`;
                }
            }
            try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){}
            return ''; 
        }

        /* Persist√™ncia e estado */
        let operacoes = [], totalCompromissada=0, totalRetorno=0, totalGanho=0;
        let filtroAtivo = false;
        let dataFiltroInicio = null;
        let dataFiltroFim = null;

        // SAVE STATE AGORA REQUER UID
        function saveState(){ 
            if (!database || !currentUserUid) {
                log("‚ùå √â necess√°rio fazer login para salvar os dados.");
                return;
            }

            const stateToSave = {
                operacoes: operacoes,
                taxaCdiAnual: document.getElementById('taxaCdiAnual').value,
                diasAno: document.getElementById('diasAno').value
            };

            // SALVA DADOS NO CAMINHO SEGURO: usuarios/UID_DO_USUARIO/operacoes
            database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).set(stateToSave)
                .then(() => {
                    log(`‚úÖ ${operacoes.length} opera√ß√µes e configura√ß√µes salvas de forma segura!`);
                })
                .catch((error) => {
                    log(`‚ùå Erro ao salvar: ${error.message}.`);
                    console.error("Firebase Save Error:", error);
                });
        }

        // FUN√á√ÉO QUE CARREGA OS DADOS AP√ìS O LOGIN (CHAMADA APENAS POR onAuthStateChanged)
        function loadStateFromFirebase(){
            if (!database || !currentUserUid) { 
                 operacoes = []; 
                 calculateAndRender(); 
                 return;
            }

            // CARREGA DADOS DO CAMINHO SEGURO: usuarios/UID_DO_USUARIO/operacoes
            database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).once('value')
                .then((snapshot) => {
                    const savedState = snapshot.val();
                    if (savedState && savedState.operacoes) {
                        operacoes = savedState.operacoes || [];
                        document.getElementById('taxaCdiAnual').value = savedState.taxaCdiAnual || '14,90';
                        document.getElementById('diasAno').value = savedState.diasAno || '252';
                        log(`üíæ ${operacoes.length} opera√ß√µes carregadas com sucesso!`);
                    } else {
                        operacoes = [];
                        log('Nenhum dado salvo encontrado para este usu√°rio.');
                    }

                    calculateAndRender(); 
                 })
                .catch(error => {
                    operacoes = [];
                    log(`‚ùå Erro ao carregar dados: ${error.message}.`);
                    console.error("Firebase Load Error:", error);
                    calculateAndRender(); 
                 });
        }
        
        function loadState() {
            // Carrega Logo salvo localmente (n√£o precisa de login)
            const savedLogo = localStorage.getItem('cdiLogo');
            if (savedLogo) {
                siteLogo.src = savedLogo;
                siteLogo.style.display = 'block';
                resetThemeToFixed();
            } else {
                siteLogo.style.display = 'none';
            }

            // O carregamento real dos dados (loadStateFromFirebase) √© disparado 
            // pelo listener do Firebase (`onAuthStateChanged`) ap√≥s o login ser bem-sucedido.
            // Apenas garante que a tela est√° limpa se n√£o houver login.
            operacoes = [];
            calculateAndRender();
        }

        function calculateAndRender() {
            const taxaGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual').value) / 100;
            const diasAno = parseNumber(document.getElementById('diasAno').value) || 252;
            const showOps = document.getElementById('showIndividualOps').checked;

            totalCompromissada = 0;
            totalRetorno = 0;
            totalGanho = 0;

            const filteredOps = operacoes.filter(op => {
                if (!filtroAtivo) return true;
                const opDate = new Date(op.data);
                if (dataFiltroInicio && opDate < dataFiltroInicio) return false;
                if (dataFiltroFim && opDate > dataFiltroFim) return false;
                return true;
            });

            // Agrupamento por Data para a visualiza√ß√£o resumida
            const resumoDiario = filteredOps.reduce((acc, op) => {
                const date = op.data; // Data normalizada (YYYY-MM-DD)
                if (!acc[date]) {
                    acc[date] = {
                        data: date,
                        compromissada: 0,
                        retorno: 0,
                        ganho: 0,
                        taxaCdiAnual: 0,
                        count: 0
                    };
                }

                acc[date].compromissada += op.compromissada;
                acc[date].retorno += op.retorno;

                // C√°lculo do ganho di√°rio (Correto para COMPRA/REVENDA)
                // Se a descri√ß√£o incluir "RECOMPRA" (ou REVenda no seu exemplo), a opera√ß√£o √© inversa (Retorno - Compromissada)
                // Se for "COMPRA" (ou Compras), a opera√ß√£o padr√£o √© (Compromissada - Retorno)
                const isRecompraOrRevenda = String(op.descricao).toUpperCase().includes('RECOMPRA') || String(op.descricao).toUpperCase().includes('REVENDA');
                
                let ganhoOp;
                if (isRecompraOrRevenda) {
                    // Recompra/Revenda: Voc√™ recebeu o retorno, o ganho √© Retorno - Compromissada
                    ganhoOp = op.retorno - op.compromissada;
                } else {
                    // Compra/Aplica√ß√£o: O retorno √© menor que o compromissada, o ganho √© (Compromissada - Retorno)
                    ganhoOp = op.compromissada - op.retorno;
                }
                
                acc[date].ganho += ganhoOp;
                acc[date].taxaCdiAnual = op.cdiTaxa || taxaGlobal * 100; // Usa a taxa da primeira op do dia como proxy para visualiza√ß√£o
                acc[date].count++;

                totalCompromissada += op.compromissada;
                totalRetorno += op.retorno;
                totalGanho += ganhoOp;

                return acc;
            }, {});

            document.getElementById('totalCompromissadaDisplay').querySelector('p').textContent = formatBRL(totalCompromissada);
            document.getElementById('totalRetornoDisplay').querySelector('p').textContent = formatBRL(totalRetorno);
            document.getElementById('totalCdiDisplay').querySelector('p').textContent = formatBRL(totalGanho);

            // Determinar qual conjunto de dados renderizar
            const dataToRender = showOps ? filteredOps : Object.values(resumoDiario);

            const tabelaHtml = document.createElement('table');
            tabelaHtml.innerHTML = `
                <thead>
                    <th>A√ß√µes</th>
                    <th>Data</th>
                    <th class="col-left">${showOps ? 'Descri√ß√£o' : 'Total de Ops'}</th>
                    <th>Banco</th>
                    <th>Valor Compromissada</th>
                    <th>Valor Retorno Bruto</th>
                    <th>Ganho (R$) Di√°rio</th>
                    <th>TX CDI Anual (%)</th>
                </thead>
                <tbody></tbody>
            `;
            const tbody = tabelaHtml.querySelector('tbody');

            dataToRender.sort((a, b) => new Date(b.data) - new Date(a.data));

            dataToRender.forEach((item, index) => {
                const isSummary = !showOps;
                
                const data = item.data;
                const descricao = isSummary ? `${item.count} Lan√ßamento(s)` : item.descricao;
                const banco = isSummary ? '-' : item.banco || '-';
                const compromissada = isSummary ? item.compromissada : item.compromissada;
                const retorno = isSummary ? item.retorno : item.retorno;
                const ganho = isSummary ? item.ganho : (item.retorno - item.compromissada); // Re-calculado para o ganho correto, que foi somado em 'item.ganho' no resumo

                const cdiTaxa = isSummary ? item.taxaCdiAnual : (item.cdiTaxa || taxaGlobal * 100);
                const ganhoDiarioPercentual = (cdiTaxa / diasAno) / 100;
                
                // O ganho percentual di√°rio √© o CDI di√°rio vezes o Valor Compromissada
                const ganhoCdiDiarioEstimado = compromissada * ganhoDiarioPercentual; 

                // Calcula o "Ganho Real" (Retorno - Compromissada) ou o Ganho que j√° est√° na vari√°vel 'ganho' se for Resumo
                let ganhoOuPerda;
                let ganhoDisplay;
                if (isSummary) {
                    ganhoOuPerda = ganho;
                } else {
                    const opIndex = operacoes.findIndex(op => op === item); // Encontra o √≠ndice da op original
                    // Recalcula o ganho real baseado na regra COMPRA/RECOMPRA
                    const isRecompraOrRevendaOp = String(item.descricao).toUpperCase().includes('RECOMPRA') || String(item.descricao).toUpperCase().includes('REVENDA');
                    ganhoOuPerda = isRecompraOrRevendaOp ? (item.retorno - item.compromissada) : (item.compromissada - item.retorno);
                }
                
                ganhoDisplay = formatBRL(ganhoOuPerda);
                const ganhoClass = ganhoOuPerda > 0 ? 'ganho' : (ganhoOuPerda < 0 ? 'perda' : '');

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="action-cell">
                        ${isSummary ? '' : `<button class="btn small secondary" onclick="editOp(${opIndex})">‚úèÔ∏è</button>`}
                        ${isSummary ? '' : `<button class="btn small danger" onclick="deleteOp(${opIndex})">‚ùå</button>`}
                    </td>
                    <td>${formatDataBR(data)}</td>
                    <td class="col-left">${descricao}</td>
                    <td>${banco}</td>
                    <td style="font-weight:700;">${formatBRL(compromissada)}</td>
                    <td style="font-weight:700;">${formatBRL(retorno)}</td>
                    <td><span class="${ganhoClass}">${ganhoDisplay}</span></td>
                    <td>${formatPercent(cdiTaxa)}</td>
                `;
            });

            document.getElementById('resultTable').innerHTML = '';
            document.getElementById('resultTable').appendChild(tabelaHtml);

            // Se o filtro estiver ativo, mostra uma notifica√ß√£o
            if (filtroAtivo) {
                log(`Filtro ativo: de ${formatDataBR(document.getElementById('filterStartDate').value)} a ${formatDataBR(document.getElementById('filterEndDate').value)}. Total de ${filteredOps.length} opera√ß√µes exibidas.`);
            } else if (operacoes.length > 0) {
                log(`Total de ${operacoes.length} opera√ß√µes carregadas.`);
            } else if (currentUserUid) {
                 log('Nenhuma opera√ß√£o salva. Comece a importar ou lan√ßar manualmente!');
            }
        }
        
        // Fun√ß√µes para CRUD
        function deleteOp(index) {
            if (confirm('Tem certeza que deseja excluir esta opera√ß√£o?')) {
                operacoes.splice(index, 1);
                calculateAndRender();
                saveState();
                log('‚ùå Opera√ß√£o exclu√≠da. Salvando...');
            }
        }

        function editOp(index) {
            const op = operacoes[index];
            if (!op) return;

            document.getElementById('manualData').value = op.data;
            document.getElementById('manualDesc').value = op.descricao;
            document.getElementById('manualBanco').value = op.banco || '';
            document.getElementById('manualCedente').value = op.contaCedente || '';
            document.getElementById('manualCessionario').value = op.contaCessionario || '';
            document.getElementById('manualCdiTaxa').value = op.cdiTaxa ? formatPercent(op.cdiTaxa) : '';
            document.getElementById('manualCompromissada').value = op.compromissada.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('manualRetorno').value = op.retorno.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('editIndex').value = index;

            document.getElementById('addBtn').textContent = 'Salvar Edi√ß√£o';
            document.getElementById('cancelEditBtn').style.display = 'inline-flex';
            log(`‚úèÔ∏è Editando opera√ß√£o de √≠ndice ${index}.`);
        }

        function cancelEdit() {
            document.getElementById('editIndex').value = '-1';
            document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('input-panel').querySelectorAll('input[type="text"], input[type="date"]').forEach(input => input.value = '');
            log('Edi√ß√£o cancelada. Pronta para novo lan√ßamento.');
        }

        document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

        // Adicionar/Editar Lan√ßamento Manual
        document.getElementById('addBtn').addEventListener('click', () => {
            const data = document.getElementById('manualData').value;
            const desc = document.getElementById('manualDesc').value;
            const banco = document.getElementById('manualBanco').value;
            const cedente = document.getElementById('manualCedente').value;
            const cessionario = document.getElementById('manualCessionario').value;
            const cdiTaxaStr = document.getElementById('manualCdiTaxa').value;
            const compromissadaStr = document.getElementById('manualCompromissada').value;
            const retornoStr = document.getElementById('manualRetorno').value;

            if (!data || !compromissadaStr || !retornoStr) {
                log('‚ö†Ô∏è Data, Valor Compromissada e Valor Retorno s√£o obrigat√≥rios.');
                return;
            }

            const cdiTaxa = cleanCdiTaxa(cdiTaxaStr);
            const compromissada = cleanCurrency(compromissadaStr);
            const retorno = cleanCurrency(retornoStr);

            const newOp = {
                data: normalizeDate(data),
                descricao: desc,
                banco: banco,
                contaCedente: cedente,
                contaCessionario: cessionario,
                cdiTaxa: cdiTaxa || null, // Guarda null se for usar a global
                compromissada: compromissada,
                retorno: retorno
            };

            const index = parseInt(document.getElementById('editIndex').value);
            if (index !== -1 && index < operacoes.length) {
                // Edi√ß√£o
                operacoes[index] = newOp;
                log(`‚úÖ Lan√ßamento editado com sucesso.`);
            } else {
                // Adi√ß√£o
                operacoes.push(newOp);
                log(`‚úÖ Lan√ßamento adicionado com sucesso.`);
            }

            // Limpa o formul√°rio e salva
            cancelEdit();
            calculateAndRender();
            saveState();
        });

        // Dele√ß√£o Total
        document.getElementById('deleteAllBtn').addEventListener('click', () => {
            if (!currentUserUid) {
                log('‚ùå Fa√ßa login primeiro para deletar seus dados.');
                return;
            }
            if (confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja excluir **TODOS** os dados salvos no seu banco de dados? Esta a√ß√£o √© IRREVERS√çVEL!')) {
                operacoes = [];
                if (database) {
                    database.ref(`${DB_ROOT_PATH}${currentUserUid}/operacoes`).remove()
                        .then(() => {
                            log('üóëÔ∏è Todos os dados foram exclu√≠dos do Firebase e localmente.');
                            calculateAndRender();
                        })
                        .catch(error => {
                            log(`‚ùå Erro ao deletar no Firebase: ${error.message}`);
                        });
                } else {
                    log('Dados limpos localmente. Firebase indispon√≠vel.');
                    calculateAndRender();
                }
            }
        });

        // Funcionalidade de Filtro
        document.getElementById('filterBtn').addEventListener('click', () => {
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;

            dataFiltroInicio = start ? new Date(start + 'T00:00:00') : null;
            dataFiltroFim = end ? new Date(end + 'T23:59:59') : null;

            filtroAtivo = !!(dataFiltroInicio || dataFiltroFim);
            calculateAndRender();
        });

        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            filtroAtivo = false;
            dataFiltroInicio = null;
            dataFiltroFim = null;
            calculateAndRender();
            log('Filtro desativado. Mostrando todos os dados.');
        });

        // Funcionalidade de Importa√ß√£o de Excel
        document.getElementById('loadExcelBtn').addEventListener('click', () => {
            const files = document.getElementById('excelFile').files;
            if (files.length === 0) {
                log('‚ö†Ô∏è Selecione um ou mais arquivos Excel/CSV primeiro.');
                return;
            }
            if (!currentUserUid) {
                log('‚ùå Fa√ßa login primeiro para importar dados para o seu usu√°rio.');
                return;
            }

            let loadedOps = [];
            let filesProcessed = 0;
            const totalFiles = files.length;

            const processFile = (file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd'});
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {raw: false, header: 1});

                        if (json.length > 1) {
                            const headerRow = json[0];
                            const headerMap = {};
                            
                            // Mapeamento de colunas (sens√≠vel ao que voc√™ usa)
                            const mapping = {
                                'data': ['DATA', 'DT. OPERA√á√ÉO', 'DATE'],
                                'descricao': ['OPERA√á√ÉO', 'DESCRI√á√ÉO', 'DESCRICAO', 'TIPO'],
                                'banco': ['BANCO', 'CONTRA PARTE'],
                                'cedente': ['CONTA CEDENTE', 'CEDENTE'],
                                'cessionario': ['CONTA CESSION√ÅRIO', 'CESSIONARIO'],
                                'compromissada': ['VALOR COMPROMISSADA', 'VALOR COMPROMISSADA (R$)', 'VALOR CPT'],
                                'retorno': ['VALOR RETORNO BRUTO', 'VALOR RETORNO (R$)', 'VALOR RTN'],
                                'cdiTaxa': ['TX. 252', 'TAXA CDI'],
                            };

                            Object.keys(mapping).forEach(key => {
                                const matchedHeader = headerRow.find(h => mapping[key].some(m => String(h).toUpperCase().includes(m)));
                                if (matchedHeader) {
                                    headerMap[key] = headerRow.indexOf(matchedHeader);
                                }
                            });

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                if (!row || !row[headerMap.data] || !row[headerMap.compromissada]) continue;

                                try {
                                    const op = {
                                        data: normalizeDate(row[headerMap.data]),
                                        descricao: row[headerMap.descricao] || 'Importado',
                                        banco: row[headerMap.banco] || '',
                                        contaCedente: row[headerMap.cedente] || '',
                                        contaCessionario: row[headerMap.cessionario] || '',
                                        compromissada: cleanCurrency(row[headerMap.compromissada]),
                                        retorno: cleanCurrency(row[headerMap.retorno]),
                                        cdiTaxa: cleanCdiTaxa(row[headerMap.cdiTaxa]) || null
                                    };
                                    
                                    // Filtra linhas inv√°lidas (compromissada = 0 ou data inv√°lida)
                                    if(op.compromissada > 0 && op.data) {
                                        loadedOps.push(op);
                                    }
                                } catch (e) {
                                    console.error("Erro ao processar linha:", i, e);
                                }
                            }
                        }
                    });

                    filesProcessed++;
                    if (filesProcessed === totalFiles) {
                        // Conclus√£o da importa√ß√£o
                        operacoes = operacoes.concat(loadedOps);
                        calculateAndRender();
                        saveState();
                        log(`‚úÖ ${loadedOps.length} novas opera√ß√µes importadas de ${totalFiles} arquivo(s). Total: ${operacoes.length}. Salvando...`);
                    }
                };
                reader.onerror = (e) => {
                    log(`‚ùå Erro ao ler o arquivo ${file.name}: ${e.target.error}`);
                    filesProcessed++;
                    if (filesProcessed === totalFiles) {
                        log('Importa√ß√£o finalizada com erros.');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            Array.from(files).forEach(processFile);
            log(`Processando ${totalFiles} arquivo(s). Aguarde...`);
        });

        // Funcionalidade de Exporta√ß√£o (para Excel)
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (operacoes.length === 0) {
                log('Nenhum dado para exportar.');
                return;
            }

            const dataToExport = operacoes.map(op => ({
                'Data': formatDataBR(op.data),
                'Descri√ß√£o': op.descricao,
                'Banco': op.banco,
                'Conta Cedente': op.contaCedente,
                'Conta Cession√°rio': op.contaCessionario,
                'Valor Compromissada (R$)': op.compromissada.toFixed(2).replace('.',','),
                'Valor Retorno Bruto (R$)': op.retorno.toFixed(2).replace('.',','),
                'TX CDI Anual (%)': op.cdiTaxa ? op.cdiTaxa.toFixed(4).replace('.',',') : '',
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Ganhos CDI");

            XLSX.writeFile(workbook, "Controle_Ganhos_CDI_Exportado.xlsx");
            log('üíæ Dados exportados para "Controle_Ganhos_CDI_Exportado.xlsx".');
        });

        // Funcionalidade de Impress√£o
        document.getElementById('printBtn').addEventListener('click', () => {
            window.print();
        });

        // Inicializa o estado local ao carregar a p√°gina
        // A l√≥gica do Firebase ser√° chamada automaticamente pelo onAuthStateChanged
        loadState();
    </script>
</body>
</html>
