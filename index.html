<script>
        /* ============================================================
           CONFIGURAÇÃO DO FIREBASE (MANTIDO)
        ============================================================ */
        const firebaseConfig = {
            apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
            authDomain: "controle-cdi.firebaseapp.com",
            databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
            projectId: "controle-cdi",
            storageBucket: "controle-cdi.firebasestorage.app",
            messagingSenderId: "215359645646",
            appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
            measurementId: "G-TV1M1QWQRC"
        };

        let database = null;
        let currentUserUid = null;
        const DB_ROOT_PATH = "usuarios/";

        firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        /* ============================================================
           LOGIN / LOGOUT (MANTIDO)
        ============================================================ */
        const loginBtn = document.getElementById("loginBtn");
        const loginMessage = document.getElementById("login-message");

        loginBtn.addEventListener("click", () => {
            if (currentUserUid) {
                firebase.auth().signOut();
                return;
            }
            firebase.auth().signInAnonymously();
        });

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUserUid = user.uid;
                loginMessage.textContent = `Status: Conectado (UID: ${user.uid.substring(0, 8)}...)`;
                loginBtn.textContent = "Logout";
                loadStateFromFirebase();
            } else {
                currentUserUid = null;
                loginMessage.textContent = "Status: Desconectado";
                loginBtn.textContent = "Login (Anônimo)";
                operacoes = [];
                calculateAndRender();
            }
        });

        /* ============================================================
           FUNÇÕES DE FORMATAÇÃO E UTILIDADE (MANTIDO)
        ============================================================ */
        function parseNumber(v){
            if(v===undefined||v===null||v==='') return 0;
            if(typeof v!=='string') v=String(v);

            // 1. Limpa moeda (R$, espaço)
            let s = v.replace(/[R$\s]/g, '');

            // 2. Tenta encontrar se o último separador é uma vírgula (indicando formato BR)
            const lastComma = s.lastIndexOf(',');
            const lastDot = s.lastIndexOf('.');

            if (lastComma > lastDot) {
                // Se a última for vírgula, trata como separador decimal (e retira pontos de milhar)
                s = s.replace(/\./g, '').replace(/,/g, '.');
            } else if (lastComma !== -1 && lastDot === -1) {
                 // Tem vírgula, mas não tem ponto. Assume vírgula como decimal.
                 s = s.replace(/,/g, '.');
            }


            let n=parseFloat(s);
            return isNaN(n)?0:n;
        }

        function cleanCdiTaxa(v){
            if(!v) return 0;
            v=String(v).replace(/[^0-9,.]/g,'').replace(/,/g,'.');
            const parts=v.split('.');
            if(parts.length>2) v=parts.slice(0,-1).join('')+'.'+parts.slice(-1);
            let n=parseFloat(v);
            return isNaN(n)?0:n;
        }
        function formatBRL(n){ return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
        function formatPercent(n){ return (n||0).toFixed(4).replace('.',','); }
        function formatPU(n){ return n? n.toLocaleString("pt-BR",{minimumFractionDigits:4,maximumFractionDigits:4}) : "-"; }
        function formatDataBR(s){
            if(!s) return "-";
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)){
                const [y,m,d]=s.split("-");
                return `${d}/${m}/${y}`;
            }
            return s;
        }
        function normalizeDate(s){
            if(!s) return "";
            s=String(s).trim();
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
            if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
                const [d,m,y]=s.split("/");
                return `${y}-${m}-${d}`;
            }
            return "";
        }

        /* ============================================================
           ESTADO PRINCIPAL (MANTIDO)
        ============================================================ */
        let operacoes = [];
        let totalCompromissada = 0;
        let totalRetorno = 0;
        let totalGanho = 0;

        let filtroAtivo = false;
        let dataFiltroInicio = null;
        let dataFiltroFim = null;

        /* ============================================================
           SALVAR E CARREGAR DO FIREBASE (MANTIDO)
        ============================================================ */
        function saveState(){
            if(!currentUserUid) return;

            const state = {
                operacoes,
                taxaCdiAnual: document.getElementById("taxaCdiAnual").value,
                diasAno: document.getElementById("diasAno").value
            };

            database.ref(DB_ROOT_PATH + currentUserUid + "/operacoes").set(state);
        }
        function loadStateFromFirebase(){
            if(!currentUserUid) return;

            database.ref(DB_ROOT_PATH + currentUserUid + "/operacoes").once("value")
            .then(snapshot=>{
                const data=snapshot.val();
                if(data){
                    operacoes = data.operacoes || [];
                    document.getElementById("taxaCdiAnual").value = data.taxaCdiAnual || "14,90";
                    document.getElementById("diasAno").value = data.diasAno || "252";
                }
                calculateAndRender();
            });
        }

        /* ============================================================
           RENDERIZAÇÃO DA TABELA REAL (MANTIDO)
        ============================================================ */
        function calculateAndRender(){
            const taxaGlobal = cleanCdiTaxa(document.getElementById("taxaCdiAnual").value)/100;
            const showOps = document.getElementById("showIndividualOps").checked;

            totalCompromissada=0;
            totalRetorno=0;
            totalGanho=0;

            const tbody=document.getElementById("resultBody");
            tbody.innerHTML="";

            let lista = operacoes.filter(op=>{
                if(!filtroAtivo) return true;
                const d = normalizeDate(op.data);
                if(dataFiltroInicio && d < dataFiltroInicio) return false;
                if(dataFiltroFim && d > dataFiltroFim) return false;
                return true;
            });

            lista.forEach((op,i)=>{
                const compromissada=parseNumber(op.compromissada);
                const retorno=parseNumber(op.retornoBruto);
                const taxa=cleanCdiTaxa(op.cdiTaxa||taxaGlobal*100)/100;

                const puIda = compromissada/(op.quantidade||1);
                const puVolta = retorno/(op.quantidade||1);

                let ganho = retorno - compromissada;
                // Lógica de inversão para "RECOMPRA" onde o retorno é menor que a compromissada
                if(op.desc && op.desc.toUpperCase().includes("RECOMPRA") && ganho<0){
                    ganho = Math.abs(ganho);
                }

                totalCompromissada+=compromissada;
                totalRetorno+=retorno;
                totalGanho+=ganho;

                if(showOps){
                    const tr=document.createElement("tr");
                    tr.innerHTML=`
                        <td>${formatDataBR(op.data)}</td>
                        <td class="col-left">${op.desc || '-'}</td>
                        <td style="text-align:left;">${op.banco || '-'}</td>
                        <td>${op.cedente || '-'}</td>
                        <td>${op.cessionario || '-'}</td>
                        <td>${formatBRL(compromissada)}</td>
                        <td>${formatBRL(retorno)}</td>
                        <td>${formatPU(puIda)}</td>
                        <td>${formatPU(puVolta)}</td>
                        <td>${formatPercent(taxa*100)}</td>
                        <td><span class="${ganho>=0?'ganho':'perda'}">${formatBRL(ganho)}</span></td>
                        <td class="action-cell">
                            <button class="btn small" onclick="editOperation(${i})">Alterar</button>
                            <button class="btn small danger" onclick="deleteOperation(${i})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.querySelector("#totalCompromissadaDisplay p").textContent = formatBRL(totalCompromissada);
            document.querySelector("#totalRetornoDisplay p").textContent = formatBRL(totalRetorno);
            document.querySelector("#totalCdiDisplay p").textContent = formatBRL(totalGanho);

            if(!showOps){
                const tr=document.createElement("tr");
                const td=document.createElement("td");
                td.colSpan=12;
                td.style.textAlign="center";
                td.style.color="var(--muted)";
                td.textContent="Detalhes ocultos. Marque a opção acima para ver a tabela.";
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }

        /* ============================================================
           FILTROS (MANTIDO)
        ============================================================ */
        document.getElementById("filterBtn").addEventListener("click",()=>{
            dataFiltroInicio=document.getElementById("filterStartDate").value;
            dataFiltroFim=document.getElementById("filterEndDate").value;
            filtroAtivo = !!dataFiltroInicio || !!dataFiltroFim;
            calculateAndRender();
        });
        document.getElementById("resetFilterBtn").addEventListener("click",()=>{
            filtroAtivo=false;
            dataFiltroInicio=null;
            dataFiltroFim=null;
            document.getElementById("filterStartDate").value="";
            document.getElementById("filterEndDate").value="";
            calculateAndRender();
        });

        /* ============================================================
           EXCLUSÃO (MANTIDO)
        ============================================================ */
        function deleteOperation(i){
            if(!confirm("Excluir esta operação?")) return;
            operacoes.splice(i,1);
            saveState();
            calculateAndRender();
        }

        document.getElementById("deleteAllBtn").addEventListener("click", () => {
            if (!confirm("Tem certeza que deseja EXCLUIR TODAS as operações? Esta ação não pode ser desfeita e será aplicada no Firebase.")) {
                return;
            }
            operacoes = [];
            saveState();
            calculateAndRender();
            alert("Todas as operações foram excluídas.");
        });

        /* ============================================================
           LANÇAMENTO MANUAL / EDIÇÃO (MANTIDO)
        ============================================================ */
        const addBtn = document.getElementById("addBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const editIndex = document.getElementById("editIndex");

        function resetManualForm() {
            document.getElementById("manualData").value = "";
            document.getElementById("manualDesc").value = "";
            document.getElementById("manualBanco").value = "";
            document.getElementById("manualCedente").value = "";
            document.getElementById("manualCessionario").value = "";
            document.getElementById("manualCdiTaxa").value = "";
            document.getElementById("manualCompromissada").value = "";
            document.getElementById("manualRetorno").value = "";

            editIndex.value = "-1";
            addBtn.textContent = "Adicionar Lançamento";
            cancelEditBtn.style.display = "none";
        }

        addBtn.addEventListener("click", () => {
            const data = document.getElementById("manualData").value;
            const desc = document.getElementById("manualDesc").value;
            const banco = document.getElementById("manualBanco").value;
            const cedente = document.getElementById("manualCedente").value;
            const cessionario = document.getElementById("manualCessionario").value;
            const cdiTaxa = document.getElementById("manualCdiTaxa").value;
            const compromissada = document.getElementById("manualCompromissada").value;
            const retorno = document.getElementById("manualRetorno").value;

            if (!data || !desc || !compromissada || !retorno) {
                alert("Preencha Data, Descrição, Valor Compromissada e Valor Retorno.");
                return;
            }

            const newOp = {
                data: normalizeDate(data),
                desc: desc,
                banco: banco,
                cedente: cedente,
                cessionario: cessionario,
                compromissada: compromissada,
                retornoBruto: retorno,
                cdiTaxa: cdiTaxa
            };

            const index = parseInt(editIndex.value);
            if (index >= 0) {
                operacoes[index] = newOp;
                alert("Operação alterada com sucesso!");
            } else {
                operacoes.push(newOp);
                alert("Operação adicionada com sucesso!");
            }

            saveState();
            calculateAndRender();
            resetManualForm();
        });

        cancelEditBtn.addEventListener("click", resetManualForm);

        window.editOperation = function(i) {
            const op = operacoes[i];

            document.getElementById("manualData").value = normalizeDate(op.data);
            document.getElementById("manualDesc").value = op.desc;
            document.getElementById("manualBanco").value = op.banco || ''; // Banco não é essencial na importação
            document.getElementById("manualCedente").value = op.cedente;
            document.getElementById("manualCessionario").value = op.cessionario;
            document.getElementById("manualCdiTaxa").value = op.cdiTaxa || "";
            
            document.getElementById("manualCompromissada").value = String(op.compromissada).replace('.', ',');
            document.getElementById("manualRetorno").value = String(op.retornoBruto).replace('.', ',');
            
            editIndex.value = i;
            addBtn.textContent = "Salvar Alteração";
            cancelEditBtn.style.display = "inline-flex";

            document.getElementById("input-panel").scrollIntoView({ behavior: "smooth" });
        }
        
        /* ============================================================
           IMPORTAÇÃO EXCEL (SheetJS) - CORRIGIDA PARA SEU ARQUIVO
        ============================================================ */

        function normalizeHeader(str){
            return String(str || "")
                .toUpperCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // remove acentos
                .replace(/[()\/$%,]/g, '') // remove parênteses, barras, cifrões e porcentagens
                .trim();
        }

        document.getElementById("loadExcelBtn").addEventListener("click",()=>{
            const files = document.getElementById("excelFile").files;
            if(files.length === 0){
                alert("Selecione um arquivo primeiro.");
                return;
            }
            // Supondo que você só quer processar o primeiro arquivo se for multiple
            const file = files[0];
            
            const reader=new FileReader();
            reader.onload=e=>{
                processExcelData(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        });

        function processExcelData(data){
            const workbook = XLSX.read(data,{type:"array"});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet,{header:1,raw:false}); // raw:false para tentar ler datas e números melhor

            if(json.length < 2){ // Deve ter pelo menos o cabeçalho e 1 linha de dados
                alert("Arquivo vazio ou com apenas o cabeçalho.");
                return;
            }

            const headers = json[0].map(h => normalizeHeader(h));
            
            const map={};

            // Mapeamento dos títulos normalizados do seu arquivo para as chaves do objeto 'operacoes'
            const known={
                "DATA DO OPERACAO":"data",               // CORRIGIDO: de 'DATA'
                "DESCRICAO DO MOVIMENTO":"desc",         // CORRIGIDO: de 'DESCRICAO'
                "CONTA CEDENTE":"cedente",               // MANTIDO, mas verificado
                "CONTA CESSIONARIO":"cessionario",       // MANTIDO, mas verificado
                "VALOR COMPROMISSADO":"compromissada",   // CORRIGIDO: de 'COMPROMISSADA'
                "VALOR BRUTO RETORNO":"retornoBruto",    // CORRIGIDO: de 'RETORNO BRUTO'
                "TAXA CDI ANUAL":"cdiTaxa",              // CORRIGIDO: de 'TX. CDI ANUAL'
                "PU DE IDA":"puIda",                     // Adicionado para referência, mas não usado no objeto final
                "PU DE VOLTA":"puVolta"                  // Adicionado para referência, mas não usado no objeto final
            };
            
            headers.forEach((h,i)=>{
                if(known[h]) map[known[h]]=i;
            });

            // Verificação de colunas obrigatórias
            if (!map.data || !map.compromissada || !map.retornoBruto) {
                alert("Não foi possível mapear as colunas obrigatórias: Data, Compromissada e Retorno Bruto. Verifique o cabeçalho do arquivo.");
                return;
            }

            const novos=[];
            for(let i=1;i<json.length;i++){
                const row=json[i];
                
                // Pular linhas incompletas
                if(!row || !row[map.data] || !row[map.compromissada]) continue;

                // Converte a data do formato do Excel se necessário (o parseNumber lida com strings/números)
                let rawDate = row[map.data];
                if (typeof rawDate === 'number' && rawDate > 1) {
                    // Excel serial date, converte para objeto Date
                    const date = XLSX.SSF.parse_date_code(rawDate, {});
                    rawDate = `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
                }


                novos.push({
                    data: normalizeDate(rawDate),
                    desc: row[map.desc]||"",
                    banco: row[map.banco]||"",
                    cedente: row[map.cedente]||"",
                    cessionario: row[map.cessionario]||"",
                    compromissada: parseNumber(row[map.compromissada]),
                    retornoBruto: parseNumber(row[map.retornoBruto]),
                    quantidade: 1, // Quantidade não está no seu CSV, assume 1
                    cdiTaxa: cleanCdiTaxa(row[map.cdiTaxa] || "")
                });
            }
            operacoes = operacoes.concat(novos);
            saveState();
            calculateAndRender();
            alert(`${novos.length} operações importadas com sucesso!`);
        }

        /* ============================================================
           CARREGAMENTO INICIAL (MANTIDO)
        ============================================================ */
        window.loadState = function(){
            calculateAndRender();
            
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            
            document.getElementById('exportBtn').addEventListener('click', () => {
                alert("Funcionalidade de Exportação será implementada aqui.");
                // Lógica de exportação para CSV ou JSON
            });

            document.getElementById('addLogoBtn').addEventListener('click', () => {
                alert("A funcionalidade de Carregar Logo requer código adicional para upload de imagem e persistência.");
            });
            document.getElementById('removeLogoBtn').addEventListener('click', () => {
                document.getElementById('siteLogo').src = '';
                document.getElementById('siteLogo').style.display = 'none';
                alert("Logo removido. A persistência do logo dependeria de código Firebase Storage.");
            });
        };
    </script>
