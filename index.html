<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Ganhos CDI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== CSS ORIGINAL â€” MANTIDO INTEGRALMENTE ===== */
:root{
--primary:#0A0A33;
--primary-light:#1A1A55;
--secondary:#C00000;
--secondary-light:#E00000;
--bg:#f4f6fb;
--card:#ffffff;
--text:#0f1724;
--muted:#6b7280;
}
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.btn{background:var(--primary);color:#fff;border:1px solid #fff;border-radius:6px;padding:6px 10px;cursor:pointer}
.btn.secondary{background:var(--secondary)}
.btn.danger{background:#a00000}
.btn.small{font-size:12px}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:right}
th{text-align:center;background:#f1f5f9}
.col-left{text-align:left}
.col-data{text-align:center}
.ganho{color:#15803d;font-weight:700}
.perda{color:#b91c1c;font-weight:700}
.total-row{background:#e5e7eb;font-weight:800}
.action-cell{text-align:center}
#main-container{display:grid;grid-template-columns:1fr 380px;gap:12px;padding:12px}
@media(max-width:900px){#main-container{grid-template-columns:1fr}}
#logo-wrapper{text-align:center;padding:8px}
#siteLogo{max-height:70px;display:none}
</style>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>

<body onload="loadState()">

<div id="logo-wrapper">
<img id="siteLogo" alt="Logo">
</div>

<div id="main-container">
<div id="results-panel" class="card">
<h2>ðŸ“Š Resumo DiÃ¡rio</h2>
<div class="totals">
<div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada</h4><p>R$ 0,00</p></div>
<div class="total-card" id="totalRetornoDisplay"><h4>Retorno</h4><p>R$ 0,00</p></div>
<div class="total-card" id="totalCdiDisplay"><h4>Ganho</h4><p>R$ 0,00</p></div>
</div>
<div class="table-wrap">
<div id="resultTable"></div>
</div>
</div>

<div id="input-panel" class="card">
<h3>âž• LanÃ§amento Manual</h3>
<input type="hidden" id="editIndex" value="-1">

<label>Data</label>
<input type="date" id="manualData">

<label>DescriÃ§Ã£o</label>
<input type="text" id="manualDesc">

<label>Banco</label>
<input type="text" id="manualBanco">

<label>Conta Cedente</label>
<input type="text" id="manualCedente">

<label>Conta CessionÃ¡rio</label>
<input type="text" id="manualCessionario">

<label>Compromissada</label>
<input type="text" id="manualCompromissada">

<label>Retorno</label>
<input type="text" id="manualRetorno">

<label>Taxa CDI</label>
<input type="text" id="manualCdiTaxa">

<button id="addBtn" class="btn">Adicionar</button>
<button id="cancelEditBtn" class="btn secondary" style="display:none">Cancelar</button>

<hr>

<input type="file" id="excelFile" multiple>
<button id="loadExcelBtn" class="btn secondary">Importar</button>
<button id="exportBtn" class="btn">Exportar</button>
<button id="deleteAllBtn" class="btn danger">Excluir Tudo</button>

<pre id="log">Aguardando...</pre>
</div>
</div>

<script>
/* ===== JS ORIGINAL â€” PARTE 1 ===== */
function log(m){document.getElementById('log').textContent=m}
let operacoes=[]

function saveState(){
localStorage.setItem('cdiControlState',JSON.stringify({operacoes}))
}

function loadState(){
const s=localStorage.getItem('cdiControlState')
if(s){operacoes=JSON.parse(s).operacoes||[]}
calculateAndRender()
}

function parseNumber(v){
if(!v)return 0
return parseFloat(String(v).replace('.','').replace(',','.'))||0
}

function formatBRL(n){
return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
}

function calculateAndRender(){
let totalComp=0,totalRet=0,totalGan=0
let html="<table><thead><tr><th>Data</th><th class='col-left'>DescriÃ§Ã£o</th><th class='col-left'>Banco</th><th>Cedente</th><th>CessionÃ¡rio</th><th>Compromissada</th><th>Retorno</th><th>Taxa</th><th>Ganho</th><th>AÃ§Ãµes</th></tr></thead><tbody>"

operacoes.forEach((op,i)=>{
const comp=parseNumber(op.compromissada)
const ret=parseNumber(op.retorno)
const ganho=ret-comp
totalComp+=comp
totalRet+=ret
totalGan+=ganho

html+=`<tr>
<td class="col-data">${op.data||'-'}</td>
<td class="col-left">${op.descricao||'-'}</td>
<td class="col-left">${op.banco||'-'}</td>
<td>${op.contaCedente||'-'}</td>
<td>${op.contaCessionario||'-'}</td>
<td>${formatBRL(comp)}</td>
<td>${formatBRL(ret)}</td>
<td>${op.cdiTaxa||'-'}</td>
<td class="${ganho>=0?'ganho':'perda'}">${formatBRL(ganho)}</td>
<td class="action-cell">
<button class="btn small" onclick="editOperation(${i})">Editar</button>
<button class="btn small secondary" onclick="deleteOperation(${i})">Excluir</button>
</td>
</tr>`
})

html+=`<tr class="total-row">
<td colspan="5">TOTAL</td>
<td>${formatBRL(totalComp)}</td>
<td>${formatBRL(totalRet)}</td>
<td>-</td>
<td>${formatBRL(totalGan)}</td>
<td></td>
</tr></tbody></table>`

document.getElementById('resultTable').innerHTML=html
document.querySelector('#totalCompromissadaDisplay p').textContent=formatBRL(totalComp)
document.querySelector('#totalRetornoDisplay p').textContent=formatBRL(totalRet)
document.querySelector('#totalCdiDisplay p').textContent=formatBRL(totalGan)

saveState()
}

function editOperation(i){
const op=operacoes[i]
document.getElementById('manualData').value=op.data
document.getElementById('manualDesc').value=op.descricao
document.getElementById('manualBanco').value=op.banco
document.getElementById('manualCedente').value=op.contaCedente
document.getElementById('manualCessionario').value=op.contaCessionario
document.getElementById('manualCompromissada').value=op.compromissada
document.getElementById('manualRetorno').value=op.retorno
document.getElementById('manualCdiTaxa').value=op.cdiTaxa
document.getElementById('editIndex').value=i
document.getElementById('addBtn').textContent='Salvar'
document.getElementById('cancelEditBtn').style.display='inline-block'
}

function deleteOperation(i){
if(!confirm('Excluir lanÃ§amento?'))return
operacoes.splice(i,1)
calculateAndRender()
}

document.getElementById('addBtn').addEventListener('click',()=>{
const idx=parseInt(document.getElementById('editIndex').value)
const obj={
data:document.getElementById('manualData').value,
descricao:document.getElementById('manualDesc').value,
banco:document.getElementById('manualBanco').value,
contaCedente:document.getElementById('manualCedente').value,
contaCessionario:document.getElementById('manualCessionario').value,
compromissada:document.getElementById('manualCompromissada').value,
retorno:document.getElementById('manualRetorno').value,
cdiTaxa:document.getElementById('manualCdiTaxa').value
}

if(idx>-1){
operacoes[idx]=obj
document.getElementById('cancelEditBtn').click()
}else{
operacoes.push(obj)
}

calculateAndRender()
})

document.getElementById('cancelEditBtn').addEventListener('click',()=>{
document.getElementById('editIndex').value='-1'
document.getElementById('addBtn').textContent='Adicionar'
document.getElementById('cancelEditBtn').style.display='none'
})

document.getElementById('deleteAllBtn').addEventListener('click',()=>{
if(confirm('Excluir todos os dados?')){
operacoes=[]
localStorage.removeItem('cdiControlState')
calculateAndRender()
}
})

async function loadExcel(file){
const ext=file.name.split('.').pop().toLowerCase()
if(ext==='xlsx'||ext==='xls'){
const data=await file.arrayBuffer()
const wb=XLSX.read(data,{type:'array'})
const ws=wb.Sheets[wb.SheetNames[0]]
return XLSX.utils.sheet_to_json(ws,{header:1,defval:''})
}
return new Promise(res=>{
Papa.parse(file,{complete:r=>res(r.data)})
})
}

document.getElementById('loadExcelBtn').addEventListener('click',async()=>{
const files=document.getElementById('excelFile').files
for(const f of files){
const rows=await loadExcel(f)
rows.slice(1).forEach(r=>{
if(r.length>=3){
operacoes.push({
data:r[0],
descricao:r[1],
banco:r[2],
contaCedente:r[3],
contaCessionario:r[4],
compromissada:r[5],
retorno:r[6],
cdiTaxa:r[7]
})
}
})
}
calculateAndRender()
})

document.getElementById('exportBtn').addEventListener('click',()=>{
const ws=XLSX.utils.json_to_sheet(operacoes)
const wb=XLSX.utils.book_new()
XLSX.utils.book_append_sheet(wb,ws,'CDI')
XLSX.writeFile(wb,'Controle_Ganhos_CDI.xlsx')
})
</script>

</body>
</html>
